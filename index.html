<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaveChat - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #0066FF;
            --secondary-blue: #00D4FF;
            --dark-blue: #0A0F2D;
            --card-blue: #1A1F3E;
            --input-blue: #252A4A;
            --text-white: #FFFFFF;
            --text-gray: #A0A8D0;
            --accent-purple: #8A2BE2;
            --online-green: #00FF88;
            --error-red: #FF4444;
            --success-green: #00CC66;
            --warning-orange: #FFAA00;
            --shadow-blue: rgba(0, 102, 255, 0.3);
        }

        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
        [data-theme="light"] {
            --primary-blue: #0066FF;
            --secondary-blue: #00A3CC;
            --dark-blue: #F5F7FF;
            --card-blue: #FFFFFF;
            --input-blue: #F8F9FF;
            --text-white: #2D3748;
            --text-gray: #718096;
            --accent-purple: #8A2BE2;
            --online-green: #00CC66;
            --error-red: #E53E3E;
            --success-green: #38A169;
            --warning-orange: #DD6B20;
            --shadow-blue: rgba(0, 102, 255, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #151A3A 100%);
            color: var(--text-white);
            min-height: 100vh;
            overflow-x: hidden;
        }

        [data-theme="light"] body {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #E6EEFF 100%);
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px var(--shadow-blue); }
            50% { box-shadow: 0 0 40px var(--primary-blue), 0 0 60px var(--accent-purple); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        @keyframes messageAppear {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.8); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
            40%, 43% { transform: translateY(-10px); }
            70% { transform: translateY(-5px); }
            90% { transform: translateY(-2px); }
        }

        @keyframes recording {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        @keyframes calling {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, var(--primary-blue), var(--accent-purple));
            transition: .4s;
            border-radius: 34px;
        }

        .theme-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        input:checked + .theme-slider:before {
            transform: translateX(30px);
            content: "‚òÄÔ∏è";
        }

        input:not(:checked) + .theme-slider:before {
            content: "üåô";
        }

        /* –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ */
        .landing-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .background-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .floating-element {
            position: absolute;
            background: linear-gradient(45deg, var(--primary-blue), var(--accent-purple));
            border-radius: 50%;
            opacity: 0.1;
            animation: float 15s ease-in-out infinite;
        }

        .floating-element:nth-child(1) {
            width: 300px;
            height: 300px;
            top: -150px;
            left: -150px;
            animation-delay: 0s;
        }

        .floating-element:nth-child(2) {
            width: 200px;
            height: 200px;
            bottom: 100px;
            right: -100px;
            animation-delay: 2s;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 0;
            position: relative;
            z-index: 10;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary-blue), var(--secondary-blue), var(--accent-purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px rgba(0, 102, 255, 0.5);
            animation: glow 3s ease-in-out infinite;
        }

        .nav-links {
            display: flex;
            gap: 35px;
            align-items: center;
        }

        .nav-link {
            color: var(--text-gray);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
            padding: 8px 0;
        }

        .nav-link:hover {
            color: var(--text-white);
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--secondary-blue);
            transition: width 0.3s ease;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        /* 3D –∫–Ω–æ–ø–∫–∏ */
        .btn-3d {
            position: relative;
            padding: 16px 32px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            overflow: hidden;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .btn-3d::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .btn-3d:hover::before {
            transform: translateX(100%);
        }

        .btn-3d-primary {
            background: linear-gradient(145deg, var(--primary-blue), #0055cc);
            color: white;
            box-shadow: 
                0 10px 20px var(--shadow-blue),
                0 6px 6px rgba(0, 102, 255, 0.2),
                inset 0 -2px 5px rgba(0, 0, 0, 0.2);
            transform: translateY(0);
        }

        .btn-3d-primary:hover {
            transform: translateY(-5px) rotateX(10deg);
            box-shadow: 
                0 15px 30px var(--shadow-blue),
                0 10px 10px rgba(0, 102, 255, 0.3),
                inset 0 -2px 8px rgba(0, 0, 0, 0.3);
        }

        .btn-3d-secondary {
            background: linear-gradient(145deg, var(--card-blue), var(--input-blue));
            color: var(--text-white);
            border: 2px solid rgba(0, 212, 255, 0.3);
            box-shadow: 
                0 8px 16px rgba(0, 0, 0, 0.1),
                0 4px 6px rgba(0, 0, 0, 0.05),
                inset 0 -2px 5px rgba(255, 255, 255, 0.1);
        }

        .btn-3d-secondary:hover {
            transform: translateY(-3px) rotateX(5deg);
            box-shadow: 
                0 12px 24px rgba(0, 0, 0, 0.15),
                0 6px 8px rgba(0, 0, 0, 0.1),
                inset 0 -2px 8px rgba(255, 255, 255, 0.15);
            border-color: var(--secondary-blue);
        }

        /* Hero —Å–µ–∫—Ü–∏—è */
        .hero-section {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 80px 0;
            position: relative;
        }

        .hero-content {
            max-width: 650px;
            animation: slideIn 1s ease-out;
        }

        .hero-title {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 25px;
            line-height: 1.1;
            background: linear-gradient(45deg, var(--text-white), var(--secondary-blue), var(--accent-purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .hero-subtitle {
            font-size: 1.3rem;
            color: var(--text-gray);
            margin-bottom: 40px;
            line-height: 1.6;
            animation: slideIn 1s ease-out 0.2s both;
        }

        .hero-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 60px;
            animation: slideIn 1s ease-out 0.4s both;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
            animation: slideIn 1s ease-out 0.6s both;
        }

        .feature-card {
            background: linear-gradient(135deg, var(--card-blue), var(--input-blue));
            padding: 35px 30px;
            border-radius: 20px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s ease;
        }

        .feature-card:hover::before {
            left: 100%;
        }

        .feature-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: var(--primary-blue);
            box-shadow: 0 20px 40px var(--shadow-blue);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 25px;
            background: linear-gradient(45deg, var(--primary-blue), var(--secondary-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .feature-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-white);
        }

        .feature-description {
            color: var(--text-gray);
            line-height: 1.6;
            font-size: 1rem;
        }

        /* –°—Ç—Ä–∞–Ω–∏—Ü—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ */
        .auth-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--card-blue) 100%);
            position: relative;
            overflow: hidden;
        }

        .auth-back {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-white);
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .auth-back:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }

        .auth-form {
            background: linear-gradient(135deg, var(--card-blue), var(--input-blue));
            padding: 50px 40px;
            border-radius: 25px;
            width: 100%;
            max-width: 480px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            animation: slideIn 0.6s ease-out;
        }

        .auth-form h2 {
            color: var(--text-white);
            margin-bottom: 35px;
            text-align: center;
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-blue), var(--secondary-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-gray);
            font-weight: 600;
            font-size: 1rem;
        }

        .form-group input {
            width: 100%;
            padding: 18px 20px;
            background: var(--input-blue);
            border: 2px solid rgba(0, 212, 255, 0.4);
            border-radius: 12px;
            font-size: 16px;
            color: var(--text-white);
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            border-color: var(--primary-blue);
            outline: none;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px var(--shadow-blue);
        }

        .form-group input.valid {
            border-color: var(--success-green);
        }

        .form-group input.invalid {
            border-color: var(--error-red);
        }

        .password-strength {
            margin-top: 12px;
            height: 6px;
            border-radius: 3px;
            background: var(--input-blue);
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            border-radius: 3px;
        }

        .password-strength.weak .password-strength-bar {
            background: var(--error-red);
            width: 33%;
        }

        .password-strength.medium .password-strength-bar {
            background: var(--warning-orange);
            width: 66%;
        }

        .password-strength.strong .password-strength-bar {
            background: var(--success-green);
            width: 100%;
        }

        .password-requirements {
            margin-top: 12px;
            font-size: 0.85rem;
        }

        .requirement {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            color: var(--text-gray);
            transition: all 0.3s;
        }

        .requirement i {
            margin-right: 8px;
            font-size: 0.8rem;
            width: 16px;
            text-align: center;
        }

        .requirement.valid {
            color: var(--success-green);
        }

        .requirement.invalid {
            color: var(--error-red);
        }

        .error-message {
            color: var(--error-red);
            font-size: 0.9rem;
            margin-top: 8px;
            display: none;
            align-items: center;
            font-weight: 500;
        }

        .error-message i {
            margin-right: 6px;
        }

        .success-message {
            color: var(--success-green);
            font-size: 0.9rem;
            margin-top: 8px;
            display: none;
            align-items: center;
            font-weight: 500;
        }

        .success-message i {
            margin-right: 6px;
        }

        .auth-btn {
            background: linear-gradient(145deg, var(--primary-blue), #0055cc);
            color: white;
            border: none;
            padding: 18px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px var(--shadow-blue);
        }

        .auth-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px var(--shadow-blue);
        }

        .auth-btn:disabled {
            background: var(--input-blue);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .auth-switch {
            margin-top: 25px;
            text-align: center;
            color: var(--text-gray);
        }

        .auth-switch a {
            color: var(--secondary-blue);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-switch a:hover {
            color: var(--primary-blue);
        }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ */
        .messenger-container {
            display: none;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--card-blue) 100%);
            position: relative;
            overflow: hidden;
        }

        .messenger-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.05;
        }

        .messenger-floating {
            position: absolute;
            background: linear-gradient(45deg, var(--primary-blue), var(--accent-purple));
            border-radius: 50%;
            animation: float 20s ease-in-out infinite;
        }

        .messenger-floating:nth-child(1) {
            width: 150px;
            height: 150px;
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }

        .messenger-floating:nth-child(2) {
            width: 100px;
            height: 100px;
            bottom: 20%;
            right: 10%;
            animation-delay: 3s;
        }

        .app-container {
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            background: linear-gradient(135deg, var(--card-blue), var(--input-blue));
            border-radius: 25px;
            overflow: hidden;
            display: flex;
            box-shadow: 0 25px 50px var(--shadow-blue);
            border: 1px solid rgba(0, 212, 255, 0.25);
            margin: 5vh auto;
            animation: slideIn 0.6s ease-out;
            backdrop-filter: blur(10px);
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —á–∞—Ç–æ–≤ */
        .sidebar {
            width: 380px;
            background: linear-gradient(180deg, var(--card-blue), var(--input-blue));
            border-right: 1px solid rgba(0, 212, 255, 0.2);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sidebar-header {
            padding: 25px;
            background: linear-gradient(135deg, var(--card-blue), var(--input-blue));
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-blue), var(--secondary-blue));
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 5px 15px var(--shadow-blue);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .avatar.online::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: var(--online-green);
            border-radius: 50%;
            border: 2px solid var(--card-blue);
            z-index: 2;
        }

        .avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px var(--shadow-blue);
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 700;
            font-size: 1.1rem;
            background: linear-gradient(45deg, var(--text-white), var(--secondary-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .user-status {
            font-size: 0.85rem;
            color: var(--online-green);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--online-green);
            animation: pulse 2s infinite;
        }

        .search-container {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.15);
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            background: var(--input-blue);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 15px;
            font-size: 15px;
            color: var(--text-white);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px var(--shadow-blue);
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-item {
            padding: 20px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.4s ease;
            margin-bottom: 12px;
            gap: 15px;
            background: linear-gradient(135deg, var(--input-blue), var(--card-blue));
            border: 1px solid rgba(0, 212, 255, 0.1);
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease-out;
            position: relative;
        }

        .chat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .chat-item:hover::before {
            left: 100%;
        }

        .chat-item:hover {
            transform: translateX(8px) translateY(-2px);
            border-color: var(--primary-blue);
            box-shadow: 0 15px 30px var(--shadow-blue);
        }

        .chat-item.active {
            background: linear-gradient(135deg, rgba(0, 102, 255, 0.2), rgba(0, 212, 255, 0.1));
            border-color: var(--primary-blue);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-white);
        }

        .last-message {
            color: var(--text-gray);
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 0.75rem;
            color: var(--text-gray);
            text-align: right;
            white-space: nowrap;
        }

        .unread-badge {
            background: linear-gradient(45deg, var(--primary-blue), var(--accent-purple));
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
            box-shadow: 0 2px 8px var(--shadow-blue);
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, var(--input-blue), var(--card-blue));
            position: relative;
        }

        .chat-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, var(--card-blue), var(--input-blue));
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 18px;
            backdrop-filter: blur(10px);
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .chat-header-actions {
            display: flex;
            gap: 10px;
        }

        .chat-messages {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 16px 20px;
            border-radius: 20px;
            position: relative;
            animation: messageAppear 0.4s ease-out;
            backdrop-filter: blur(10px);
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .message.sent {
            background: linear-gradient(135deg, var(--primary-blue), #0055cc);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 8px;
        }

        .message.received {
            background: linear-gradient(135deg, var(--input-blue), var(--card-blue));
            color: var(--text-white);
            margin-right: auto;
            border-bottom-left-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .message.editing {
            border: 2px solid var(--warning-orange);
            box-shadow: 0 0 15px var(--warning-orange);
        }

        .message-actions {
            position: absolute;
            top: -10px;
            right: 10px;
            display: none;
            gap: 5px;
            background: var(--card-blue);
            border-radius: 10px;
            padding: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action {
            background: var(--input-blue);
            border: none;
            color: var(--text-gray);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }

        .message-action:hover {
            background: var(--primary-blue);
            color: white;
            transform: scale(1.1);
        }

        .message-action.delete:hover {
            background: var(--error-red);
        }

        .message-action.edit:hover {
            background: var(--warning-orange);
        }

        .file-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-top: 8px;
        }

        .file-icon {
            font-size: 1.5rem;
            color: var(--primary-blue);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .file-size {
            font-size: 0.8rem;
            color: var(--text-gray);
        }

        .download-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .download-btn:hover {
            background: var(--secondary-blue);
        }

        .message-time {
            font-size: 0.7rem;
            margin-top: 6px;
            opacity: 0.7;
            text-align: right;
        }

        .message-status {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            margin-top: 4px;
            opacity: 0.8;
        }

        .edited-indicator {
            font-size: 0.65rem;
            color: var(--text-gray);
            margin-left: 5px;
            font-style: italic;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            color: var(--text-gray);
            font-size: 0.9rem;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--secondary-blue);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .welcome-message {
            text-align: center;
            color: var(--text-gray);
            margin-top: 100px;
            padding: 40px;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(45deg, var(--text-white), var(--secondary-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .welcome-subtitle {
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .chat-input-container {
            padding: 25px 30px;
            background: linear-gradient(135deg, var(--card-blue), var(--input-blue));
            border-top: 1px solid rgba(0, 212, 255, 0.2);
            display: flex;
            align-items: flex-end;
            gap: 15px;
            backdrop-filter: blur(10px);
        }

        .file-upload-container {
            position: relative;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        .message-input {
            flex: 1;
            padding: 16px 20px;
            background: var(--input-blue);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 25px;
            font-size: 16px;
            color: var(--text-white);
            resize: none;
            max-height: 120px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            line-height: 1.5;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--shadow-blue);
        }

        .action-btn {
            background: linear-gradient(135deg, var(--input-blue), var(--card-blue));
            border: 2px solid rgba(0, 212, 255, 0.2);
            color: var(--text-gray);
            cursor: pointer;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, var(--primary-blue), #0055cc);
            border-color: var(--primary-blue);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 5px 15px var(--shadow-blue);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary-blue), #0055cc);
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px var(--shadow-blue);
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 8px 25px var(--shadow-blue);
        }

        .send-btn:disabled {
            background: var(--input-blue);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .voice-message-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            margin-top: 8px;
        }

        .voice-play-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voice-play-btn:hover {
            background: var(--secondary-blue);
            transform: scale(1.1);
        }

        .voice-waveform {
            flex: 1;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .voice-wave {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        .voice-bar {
            width: 3px;
            background: var(--primary-blue);
            border-radius: 2px;
            transition: height 0.3s ease;
        }

        .voice-duration {
            font-size: 0.8rem;
            color: var(--text-gray);
            min-width: 40px;
            text-align: center;
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255, 0, 0, 0.2);
            border-radius: 25px;
            margin-top: 8px;
            animation: recording 1s infinite;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: var(--error-red);
            border-radius: 50%;
        }

        .recording-text {
            font-size: 0.9rem;
            color: var(--error-red);
            font-weight: 600;
        }

        .recording-timer {
            font-size: 0.9rem;
            color: var(--error-red);
            font-weight: 600;
        }

        /* –§–æ—Ä–º—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è */
        .drawing-container {
            position: absolute;
            bottom: 90px;
            left: 30px;
            right: 30px;
            background: var(--card-blue);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 100;
            display: none;
        }

        .drawing-canvas-container {
            width: 100%;
            height: 200px;
            background: var(--input-blue);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .drawing-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .drawing-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .shape-selector {
            display: flex;
            gap: 10px;
        }

        .shape-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--input-blue);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .shape-btn:hover {
            background: var(--primary-blue);
            color: white;
        }

        .shape-btn.active {
            border-color: var(--primary-blue);
            background: var(--primary-blue);
            color: white;
        }

        .color-selector {
            display: flex;
            gap: 8px;
        }

        .color-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .color-btn:hover {
            transform: scale(1.2);
        }

        .color-btn.active {
            border-color: white;
            transform: scale(1.2);
        }

        .drawing-actions {
            display: flex;
            gap: 10px;
        }

        /* –ó–≤–æ–Ω–∫–∏ */
        .call-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .call-info {
            text-align: center;
            margin-bottom: 40px;
        }

        .call-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-blue), var(--accent-purple));
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 3rem;
            margin: 0 auto 20px;
            animation: calling 2s infinite;
            background-size: cover;
            background-position: center;
        }

        .call-name {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .call-status {
            font-size: 1.2rem;
            color: var(--text-gray);
        }

        .call-controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .call-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .call-btn:hover {
            transform: scale(1.1);
        }

        .call-btn.accept {
            background: var(--success-green);
            color: white;
        }

        .call-btn.decline {
            background: var(--error-red);
            color: white;
        }

        .call-btn.end {
            background: var(--error-red);
            color: white;
        }

        .call-btn.mute {
            background: var(--warning-orange);
            color: white;
        }

        .call-btn.mute.muted {
            background: var(--error-red);
        }

        .call-btn.video {
            background: var(--primary-blue);
            color: white;
        }

        .call-btn.video.off {
            background: var(--error-red);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, var(--card-blue), var(--input-blue));
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
            backdrop-filter: blur(10px);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-blue), var(--secondary-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-white);
        }

        .settings-option {
            margin-bottom: 20px;
        }

        .settings-option label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-gray);
            font-weight: 600;
        }

        .settings-option input, .settings-option select {
            width: 100%;
            padding: 12px 16px;
            background: var(--input-blue);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            font-size: 16px;
            color: var(--text-white);
        }

        .settings-option input:focus, .settings-option select:focus {
            border-color: var(--primary-blue);
            outline: none;
        }

        .theme-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .theme-label {
            color: var(--text-gray);
            font-weight: 600;
        }

        .avatar-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--input-blue);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 1.2rem;
            background-size: cover;
            background-position: center;
        }

        .avatar-option:hover {
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border: 3px solid var(--primary-blue);
        }

        .avatar-upload {
            margin-top: 20px;
            text-align: center;
        }

        .avatar-upload input {
            display: none;
        }

        .avatar-upload label {
            display: inline-block;
            padding: 10px 20px;
            background: var(--input-blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-gray);
        }

        .avatar-upload label:hover {
            background: var(--primary-blue);
            color: white;
        }

        .wallpaper-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .wallpaper-option {
            height: 80px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }

        .wallpaper-option::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .wallpaper-option:hover::after {
            background: rgba(0, 0, 0, 0.1);
        }

        .wallpaper-option.selected {
            border: 3px solid var(--primary-blue);
        }

        .wallpaper-option.selected::after {
            background: rgba(0, 0, 0, 0);
        }

        .wallpaper-name {
            position: absolute;
            bottom: 5px;
            left: 5px;
            color: white;
            font-size: 0.7rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 5px;
            border-radius: 3px;
            z-index: 2;
        }

        .custom-wallpaper-upload {
            margin-top: 15px;
            text-align: center;
        }

        .custom-wallpaper-upload input {
            display: none;
        }

        .custom-wallpaper-upload label {
            display: inline-block;
            padding: 10px 20px;
            background: var(--input-blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-gray);
        }

        .custom-wallpaper-upload label:hover {
            background: var(--primary-blue);
            color: white;
        }

        .settings-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .clear-data-btn {
            background: linear-gradient(145deg, var(--error-red), #cc3333);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .clear-data-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 68, 68, 0.3);
        }

        /* Ripple —ç—Ñ—Ñ–µ–∫—Ç */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            max-width: 300px;
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success-green), #00aa55);
            border-left: 4px solid var(--success-green);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--error-red), #cc3333);
            border-left: 4px solid var(--error-red);
        }

        .notification.info {
            background: linear-gradient(135deg, var(--primary-blue), #0055cc);
            border-left: 4px solid var(--primary-blue);
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ */
        .upload-progress {
            width: 100%;
            height: 4px;
            background: var(--input-blue);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), var(--secondary-blue));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .uploading {
            opacity: 0.7;
        }

        .uploading .message-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-white);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mobile-menu {
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            height: 100%;
            background: linear-gradient(135deg, var(--card-blue), var(--input-blue));
            z-index: 1000;
            transition: left 0.3s ease;
            padding: 20px;
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }

        .mobile-menu.active {
            left: 0;
        }

        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }

        .mobile-menu-close {
            background: none;
            border: none;
            color: var(--text-white);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .mobile-nav-links {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .mobile-nav-link {
            color: var(--text-gray);
            text-decoration: none;
            font-size: 1.2rem;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            transition: all 0.3s;
        }

        .mobile-nav-link:hover {
            color: var(--text-white);
            transform: translateX(10px);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .hero-title {
                font-size: 2.5rem;
            }
            
            .hero-buttons {
                flex-direction: column;
            }
            
            .btn-3d {
                padding: 14px 28px;
                font-size: 1rem;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .app-container {
                flex-direction: column;
                height: 100vh;
                margin: 0;
                border-radius: 0;
                width: 100%;
            }
            
            .sidebar {
                width: 100%;
                height: 40%;
            }
            
            .chat-content {
                height: 60%;
            }
            
            .message {
                max-width: 85%;
            }
            
            .auth-form {
                padding: 30px 20px;
            }
            
            .modal-content {
                padding: 20px;
                width: 95%;
            }
            
            .settings-actions {
                flex-direction: column;
            }
            
            .wallpaper-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .call-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .call-btn {
                width: 60px;
                height: 60px;
            }
        }

        @media (max-width: 480px) {
            .hero-title {
                font-size: 2rem;
            }
            
            .hero-subtitle {
                font-size: 1.1rem;
            }
            
            .feature-card {
                padding: 25px 20px;
            }
            
            .chat-header {
                padding: 15px 20px;
            }
            
            .chat-messages {
                padding: 20px;
            }
            
            .chat-input-container {
                padding: 15px 20px;
            }
            
            .action-btn, .send-btn {
                width: 42px;
                height: 42px;
            }
            
            .message-input {
                padding: 12px 16px;
            }
            
            .wallpaper-options {
                grid-template-columns: 1fr;
            }
            
            .drawing-container {
                left: 15px;
                right: 15px;
                bottom: 80px;
            }
        }

        /* –ú–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç */
        .media-content {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 8px;
        }

        .image-message {
            max-width: 300px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-message:hover {
            transform: scale(1.02);
        }

        .video-message {
            max-width: 300px;
            border-radius: 10px;
            overflow: hidden;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–¥–∏–∞ */
        .media-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .media-modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            overflow: hidden;
            animation: fadeIn 0.3s ease-out;
        }

        .media-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            font-size: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .media-modal-close:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .confirm-content {
            background: linear-gradient(135deg, var(--card-blue), var(--input-blue));
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .confirm-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-white);
        }

        .confirm-text {
            color: var(--text-gray);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            flex: 1;
        }

        .confirm-btn.cancel {
            background: var(--input-blue);
            color: var(--text-white);
        }

        .confirm-btn.delete {
            background: linear-gradient(145deg, var(--error-red), #cc3333);
            color: white;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
    <div class="landing-page" id="landing-page">
        <div class="background-animation">
            <div class="floating-element"></div>
            <div class="floating-element"></div>
        </div>

        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">WAVECHAT</div>
                    <button class="mobile-menu-btn" id="mobile-menu-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <nav class="nav-links">
                        <a href="#" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
                        <a href="#" class="nav-link">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</a>
                        <a href="#" class="nav-link">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</a>
                        <div class="theme-option">
                            <span class="theme-label">–¢–µ–º–∞</span>
                            <label class="theme-switch">
                                <input type="checkbox" id="theme-toggle">
                                <span class="theme-slider"></span>
                            </label>
                        </div>
                    </nav>
                    <div class="auth-buttons">
                        <button class="btn-3d btn-3d-secondary" id="landing-login-btn">–í–æ–π—Ç–∏</button>
                        <button class="btn-3d btn-3d-primary" id="landing-register-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                    </div>
                </div>
            </div>
        </header>

        <section class="hero-section">
            <div class="container">
                <div class="hero-content">
                    <h1 class="hero-title">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h1>
                    <p class="hero-subtitle">WaveChat –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –ø–æ–ª–Ω–æ–π –∑–∞—â–∏—Ç–æ–π –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.</p>
                    <div class="hero-buttons">
                        <button class="btn-3d btn-3d-primary" id="hero-register-btn">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
                        <button class="btn-3d btn-3d-secondary" id="learn-more-btn">–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ</button>
                    </div>
                    
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h3 class="feature-title">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h3>
                            <p class="feature-description">–í—Å–µ –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º. –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <h3 class="feature-title">–°–∫–æ—Ä–æ—Å—Ç—å</h3>
                            <p class="feature-description">–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–∞–∂–µ –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏.</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <h3 class="feature-title">–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å</h3>
                            <p class="feature-description">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∑–∞—â–∏—â–µ–Ω–Ω–æ–π –±–∞–∑–µ. –í—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é -->
    <div class="mobile-menu" id="mobile-menu">
        <div class="mobile-menu-header">
            <div class="logo">WAVECHAT</div>
            <button class="mobile-menu-close" id="mobile-menu-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="mobile-nav-links">
            <a href="#" class="mobile-nav-link">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="#" class="mobile-nav-link">–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</a>
            <a href="#" class="mobile-nav-link">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</a>
            <div class="theme-option">
                <span class="theme-label">–¢–µ–º–∞</span>
                <label class="theme-switch">
                    <input type="checkbox" id="mobile-theme-toggle">
                    <span class="theme-slider"></span>
                </label>
            </div>
            <button class="btn-3d btn-3d-secondary" id="mobile-login-btn">–í–æ–π—Ç–∏</button>
            <button class="btn-3d btn-3d-primary" id="mobile-register-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </nav>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
    <div class="auth-container" id="auth-container">
        <button class="auth-back" id="auth-back-btn">
            <i class="fas fa-arrow-left"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é
        </button>
        
        <div class="auth-form" id="login-form">
            <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
            <div class="form-group">
                <label for="login-username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" id="login-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à username">
                <div class="error-message" id="login-username-error">
                    <i class="fas fa-exclamation-circle"></i> –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                </div>
            </div>
            <div class="form-group">
                <label for="login-password">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="login-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å">
                <div class="error-message" id="login-password-error">
                    <i class="fas fa-exclamation-circle"></i> –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å
                </div>
            </div>
            <button class="auth-btn" id="login-btn">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</button>
            <div class="auth-switch">
                –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="switch-to-register">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</a>
            </div>
        </div>

        <div class="auth-form" id="register-form" style="display: none;">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <div class="form-group">
                <label for="register-username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" id="register-username" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ username (—Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã)">
                <div class="error-message" id="register-username-error">
                    <i class="fas fa-exclamation-circle"></i> –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã (3-20 —Å–∏–º–≤–æ–ª–æ–≤)
                </div>
                <div class="success-message" id="register-username-success">
                    <i class="fas fa-check-circle"></i> –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ
                </div>
            </div>
            <div class="form-group">
                <label for="register-password">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="register-password" placeholder="–°–æ–∑–¥–∞–π—Ç–µ –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å">
                <div class="password-strength" id="password-strength">
                    <div class="password-strength-bar"></div>
                </div>
                <div class="password-requirements">
                    <div class="requirement" id="length-req">
                        <i class="fas fa-times"></i> –ù–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤
                    </div>
                    <div class="requirement" id="lowercase-req">
                        <i class="fas fa-times"></i> –°–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã
                    </div>
                    <div class="requirement" id="uppercase-req">
                        <i class="fas fa-times"></i> –°–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–≥–ª–∞–≤–Ω—ã–µ –±—É–∫–≤—ã
                    </div>
                    <div class="requirement" id="number-req">
                        <i class="fas fa-times"></i> –°–æ–¥–µ—Ä–∂–∏—Ç —Ü–∏—Ñ—Ä—ã
                    </div>
                    <div class="requirement" id="special-req">
                        <i class="fas fa-times"></i> –°–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
                    </div>
                </div>
                <div class="error-message" id="register-password-error">
                    <i class="fas fa-exclamation-circle"></i> –ü–∞—Ä–æ–ª—å –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
                </div>
            </div>
            <div class="form-group">
                <label for="confirm-password">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
                <input type="password" id="confirm-password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <div class="error-message" id="confirm-password-error">
                    <i class="fas fa-exclamation-circle"></i> –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
                </div>
            </div>
            <button class="auth-btn" id="register-btn" disabled>–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <div class="auth-switch">
                –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="switch-to-login">–í–æ–π—Ç–∏</a>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ -->
    <div class="messenger-container" id="messenger-container">
        <div class="messenger-bg">
            <div class="messenger-floating"></div>
            <div class="messenger-floating"></div>
        </div>
        
        <div class="app-container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="user-info">
                        <div class="avatar online" id="user-avatar">U</div>
                        <div class="user-details">
                            <div class="user-name" id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                            <div class="user-status">
                                <span class="status-dot"></span> –æ–Ω–ª–∞–π–Ω
                            </div>
                        </div>
                    </div>
                    <div>
                        <button class="btn-3d btn-3d-secondary" id="settings-btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="btn-3d btn-3d-secondary" id="logout-btn" title="–í—ã–π—Ç–∏">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="search-container">
                    <input type="text" class="search-input" id="global-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
                </div>
                
                <div class="chats-list" id="chats-list">
                    <div class="welcome-message">
                        <div class="welcome-title">–í–∞—à–∏ —á–∞—Ç—ã</div>
                        <div class="welcome-subtitle">–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –≤–∞—à–∏ –±–µ—Å–µ–¥—ã</div>
                    </div>
                </div>
            </div>
            
            <div class="chat-content">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <div class="avatar" id="current-chat-avatar">?</div>
                        <div class="user-details">
                            <div class="user-name" id="current-chat-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
                            <div class="user-status" id="current-chat-status">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</div>
                        </div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="btn-3d btn-3d-secondary" id="voice-call-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn-3d btn-3d-secondary" id="video-call-btn" title="–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫">
                            <i class="fas fa-video"></i>
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="welcome-message">
                        <div class="welcome-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ WaveChat!</div>
                        <div class="welcome-subtitle">
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –±–µ—Å–µ–¥—É</p>
                            <p>–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∑–∞—â–∏—â–µ–Ω–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</p>
                        </div>
                    </div>
                </div>
                
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è -->
                <div class="drawing-container" id="drawing-container">
                    <div class="drawing-canvas-container">
                        <canvas class="drawing-canvas" id="drawing-canvas" width="400" height="200"></canvas>
                    </div>
                    <div class="drawing-controls">
                        <div class="shape-selector">
                            <button class="shape-btn active" data-shape="line" title="–õ–∏–Ω–∏—è">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button class="shape-btn" data-shape="circle" title="–ö—Ä—É–≥">
                                <i class="fas fa-circle"></i>
                            </button>
                            <button class="shape-btn" data-shape="rectangle" title="–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫">
                                <i class="fas fa-square"></i>
                            </button>
                            <button class="shape-btn" data-shape="triangle" title="–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="shape-btn" data-shape="star" title="–ó–≤–µ–∑–¥–∞">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="shape-btn" data-shape="heart" title="–°–µ—Ä–¥—Ü–µ">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                        <div class="color-selector">
                            <div class="color-btn active" style="background-color: #0066FF;" data-color="#0066FF"></div>
                            <div class="color-btn" style="background-color: #FF4444;" data-color="#FF4444"></div>
                            <div class="color-btn" style="background-color: #00CC66;" data-color="#00CC66"></div>
                            <div class="color-btn" style="background-color: #FFAA00;" data-color="#FFAA00"></div>
                            <div class="color-btn" style="background-color: #8A2BE2;" data-color="#8A2BE2"></div>
                        </div>
                    </div>
                    <div class="drawing-actions">
                        <button class="btn-3d btn-3d-secondary" id="clear-drawing-btn">
                            <i class="fas fa-eraser"></i> –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                        <button class="btn-3d btn-3d-primary" id="send-drawing-btn">
                            <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                        <button class="btn-3d btn-3d-secondary" id="close-drawing-btn">
                            <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="file-upload-container">
                        <input type="file" id="file-input" class="file-input" accept="image/*, video/*" multiple>
                        <button class="action-btn" id="file-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                            <i class="fas fa-paperclip"></i>
                        </button>
                    </div>
                    <button class="action-btn" id="voice-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="action-btn" id="draw-btn" title="–†–∏—Å–æ–≤–∞–Ω–∏–µ">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="action-btn" id="emoji-btn" title="–≠–º–æ–¥–∑–∏">
                        <i class="fas fa-smile"></i>
                    </button>
                    <textarea class="message-input" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1" disabled></textarea>
                    <button class="send-btn" id="send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –û–∫–Ω–æ –∑–≤–æ–Ω–∫–∞ -->
    <div class="call-container" id="call-container">
        <div class="call-info">
            <div class="call-avatar" id="call-avatar">?</div>
            <div class="call-name" id="call-name">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            <div class="call-status" id="call-status">–ó–≤–æ–Ω–æ–∫...</div>
        </div>
        <div class="call-controls">
            <button class="call-btn accept" id="accept-call-btn" title="–ü—Ä–∏–Ω—è—Ç—å">
                <i class="fas fa-phone"></i>
            </button>
            <button class="call-btn decline" id="decline-call-btn" title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å">
                <i class="fas fa-phone-slash"></i>
            </button>
            <button class="call-btn end" id="end-call-btn" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å" style="display: none;">
                <i class="fas fa-phone-slash"></i>
            </button>
            <button class="call-btn mute" id="mute-call-btn" title="–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω" style="display: none;">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="call-btn video" id="video-toggle-btn" title="–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É" style="display: none;">
                <i class="fas fa-video"></i>
            </button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="theme-option">
                <span class="theme-label">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</span>
                <label class="theme-switch">
                    <input type="checkbox" id="theme-setting">
                    <span class="theme-slider"></span>
                </label>
            </div>

            <div class="settings-option">
                <label for="username-setting">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" id="username-setting" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <div class="error-message" id="username-error">
                    <i class="fas fa-exclamation-circle"></i> –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã (3-20 —Å–∏–º–≤–æ–ª–æ–≤)
                </div>
            </div>

            <div class="settings-option">
                <label for="notifications-setting">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
                <select id="notifications-setting">
                    <option value="all">–í—Å–µ</option>
                    <option value="mentions">–¢–æ–ª—å–∫–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è</option>
                    <option value="none">–û—Ç–∫–ª—é—á–∏—Ç—å</option>
                </select>
            </div>

            <div class="settings-option">
                <label>–°–º–µ–Ω–∞ –∞–≤–∞—Ç–∞—Ä–∞</label>
                <div class="avatar-options">
                    <div class="avatar-option" data-avatar="AL">AL</div>
                    <div class="avatar-option" data-avatar="MA">MA</div>
                    <div class="avatar-option" data-avatar="DM">DM</div>
                    <div class="avatar-option" data-avatar="AN">AN</div>
                </div>
                <div class="avatar-upload">
                    <input type="file" id="avatar-upload" accept="image/*">
                    <label for="avatar-upload">
                        <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—é –∞–≤–∞—Ç–∞—Ä–∫—É
                    </label>
                </div>
            </div>

            <div class="settings-option">
                <label>–û–±–æ–∏ —á–∞—Ç–∞</label>
                <div class="wallpaper-options">
                    <div class="wallpaper-option selected" data-wallpaper="default" style="background: linear-gradient(135deg, var(--input-blue), var(--card-blue));">
                        <span class="wallpaper-name">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</span>
                    </div>
                    <div class="wallpaper-option" data-wallpaper="mountains" style="background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80');">
                        <span class="wallpaper-name">–ì–æ—Ä—ã</span>
                    </div>
                    <div class="wallpaper-option" data-wallpaper="field" style="background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80');">
                        <span class="wallpaper-name">–ü–æ–ª–µ</span>
                    </div>
                    <div class="wallpaper-option" data-wallpaper="office" style="background-image: url('https://images.unsplash.com/photo-1497366754035-f200968a6e72?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80');">
                        <span class="wallpaper-name">–û—Ñ–∏—Å</span>
                    </div>
                    <div class="wallpaper-option" data-wallpaper="tea" style="background-image: url('https://images.unsplash.com/photo-1544787219-7f47ccb76574?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80');">
                        <span class="wallpaper-name">–ß–∞–π</span>
                    </div>
                    <div class="wallpaper-option" data-wallpaper="beach" style="background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80');">
                        <span class="wallpaper-name">–ü–ª—è–∂</span>
                    </div>
                    <div class="wallpaper-option" data-wallpaper="forest" style="background-image: url('https://images.unsplash.com/photo-1448375240586-882707db888b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80');">
                        <span class="wallpaper-name">–õ–µ—Å</span>
                    </div>
                    <div class="wallpaper-option" data-wallpaper="night" style="background-image: url('https://images.unsplash.com/photo-1532978379173-523e16f3717d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80');">
                        <span class="wallpaper-name">–ù–æ—á—å</span>
                    </div>
                    <div class="wallpaper-option" data-wallpaper="empty" style="background-color: var(--input-blue);">
                        <span class="wallpaper-name">–ü—É—Å—Ç–æ</span>
                    </div>
                </div>
                <div class="custom-wallpaper-upload">
                    <input type="file" id="wallpaper-upload" accept="image/*">
                    <label for="wallpaper-upload">
                        <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–∏ –æ–±–æ–∏
                    </label>
                </div>
            </div>

            <div class="settings-actions">
                <button class="btn-3d btn-3d-primary" id="save-settings-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="clear-data-btn" id="clear-data-btn">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <button class="btn-3d btn-3d-secondary" id="cancel-settings-btn">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–¥–∏–∞ -->
    <div class="media-modal" id="media-modal">
        <button class="media-modal-close" id="media-modal-close">
            <i class="fas fa-times"></i>
        </button>
        <img class="media-modal-content" id="media-modal-content" src="" alt="">
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-content">
            <h3 class="confirm-title">–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
            <p class="confirm-text">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            <div class="confirm-actions">
                <button class="confirm-btn cancel" id="confirm-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-btn delete" id="confirm-delete">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ localStorage
        class WaveChatDB {
            constructor() {
                this.storage = localStorage;
                this.init();
            }

            init() {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                this.restoreSession();
            }

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
            saveSession(user) {
                this.storage.setItem('wavechat_current_user', JSON.stringify(user));
            }

            getCurrentSession() {
                const session = this.storage.getItem('wavechat_current_user');
                return session ? JSON.parse(session) : null;
            }

            clearSession() {
                this.storage.removeItem('wavechat_current_user');
            }

            restoreSession() {
                const currentUser = this.getCurrentSession();
                if (currentUser) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    currentUser.lastSeen = new Date().toISOString();
                    currentUser.isOnline = true;
                    this.saveSession(currentUser);
                    this.updateUser(currentUser.id, {
                        lastSeen: currentUser.lastSeen,
                        isOnline: true
                    });
                }
                return currentUser;
            }

            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            async addUser(user) {
                const users = this.getUsers();
                users.push(user);
                this.storage.setItem('wavechat_users', JSON.stringify(users));
                this.saveSession(user); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
                return user.id;
            }

            getUsers() {
                return JSON.parse(this.storage.getItem('wavechat_users') || '[]');
            }

            async getUserByUsername(username) {
                const users = this.getUsers();
                return users.find(user => user.username === username);
            }

            async getUserById(userId) {
                const users = this.getUsers();
                return users.find(user => user.id === userId);
            }

            async getAllUsers() {
                return this.getUsers();
            }

            async searchUsers(query) {
                const users = this.getUsers();
                const searchTerm = query.toLowerCase();
                return users.filter(user => 
                    user.username.toLowerCase().includes(searchTerm)
                );
            }

            async updateUser(userId, updates) {
                const users = this.getUsers();
                const userIndex = users.findIndex(user => user.id === userId);
                if (userIndex !== -1) {
                    users[userIndex] = { ...users[userIndex], ...updates };
                    this.storage.setItem('wavechat_users', JSON.stringify(users));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    const currentUser = this.getCurrentSession();
                    if (currentUser && currentUser.id === userId) {
                        this.saveSession(users[userIndex]);
                    }
                    
                    return users[userIndex];
                }
                return null;
            }

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            async getSettings(userId) {
                const settings = JSON.parse(this.storage.getItem('wavechat_settings') || '{}');
                return settings[userId] || {};
            }

            async saveSettings(userId, newSettings) {
                const settings = JSON.parse(this.storage.getItem('wavechat_settings') || '{}');
                settings[userId] = { ...settings[userId], ...newSettings };
                this.storage.setItem('wavechat_settings', JSON.stringify(settings));
            }

            // –ß–∞—Ç—ã
            async addChat(chat) {
                const chats = this.getChats();
                chats.push(chat);
                this.storage.setItem('wavechat_chats', JSON.stringify(chats));
                return chat.id;
            }

            getChats() {
                return JSON.parse(this.storage.getItem('wavechat_chats') || '[]');
            }

            async getChat(chatId) {
                const chats = this.getChats();
                return chats.find(chat => chat.id === chatId);
            }

            async getUserChats(userId) {
                const chats = this.getChats();
                return chats.filter(chat => 
                    chat.participants.includes(userId)
                ).sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            }

            async getAllChats() {
                return this.getChats();
            }

            async findChatBetweenUsers(user1Id, user2Id) {
                const chats = this.getChats();
                return chats.find(chat =>
                    chat.participants.includes(user1Id) &&
                    chat.participants.includes(user2Id) &&
                    chat.participants.length === 2
                );
            }

            async updateChat(chatId, updates) {
                const chats = this.getChats();
                const chatIndex = chats.findIndex(chat => chat.id === chatId);
                if (chatIndex !== -1) {
                    chats[chatIndex] = { ...chats[chatIndex], ...updates };
                    this.storage.setItem('wavechat_chats', JSON.stringify(chats));
                    return chats[chatIndex];
                }
                return null;
            }

            // –°–æ–æ–±—â–µ–Ω–∏—è
            async addMessage(message) {
                const messages = this.getMessages();
                messages.push(message);
                this.storage.setItem('wavechat_messages', JSON.stringify(messages));
                return message.id;
            }

            getMessages() {
                return JSON.parse(this.storage.getItem('wavechat_messages') || '[]');
            }

            async getChatMessages(chatId) {
                const messages = this.getMessages();
                return messages
                    .filter(message => message.chatId === chatId)
                    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            }

            async getLastMessage(chatId) {
                const messages = await this.getChatMessages(chatId);
                return messages[messages.length - 1];
            }

            async updateMessage(messageId, updates) {
                const messages = this.getMessages();
                const messageIndex = messages.findIndex(message => message.id === messageId);
                if (messageIndex !== -1) {
                    messages[messageIndex] = { ...messages[messageIndex], ...updates };
                    this.storage.setItem('wavechat_messages', JSON.stringify(messages));
                    return messages[messageIndex];
                }
                return null;
            }

            async deleteMessage(messageId) {
                const messages = this.getMessages();
                const messageIndex = messages.findIndex(message => message.id === messageId);
                if (messageIndex !== -1) {
                    const deletedMessage = messages.splice(messageIndex, 1)[0];
                    this.storage.setItem('wavechat_messages', JSON.stringify(messages));
                    return deletedMessage;
                }
                return null;
            }

            // –§–∞–π–ª—ã
            async addFile(file) {
                const files = this.getFiles();
                files.push(file);
                this.storage.setItem('wavechat_files', JSON.stringify(files));
                return file.id;
            }

            getFiles() {
                return JSON.parse(this.storage.getItem('wavechat_files') || '[]');
            }

            async getFile(fileId) {
                const files = this.getFiles();
                return files.find(file => file.id === fileId);
            }

            // –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            clearDatabase() {
                this.storage.removeItem('wavechat_users');
                this.storage.removeItem('wavechat_chats');
                this.storage.removeItem('wavechat_messages');
                this.storage.removeItem('wavechat_files');
                this.storage.removeItem('wavechat_settings');
                this.clearSession();
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        function validateUsername(username) {
            const regex = /^[a-zA-Z0-9]{3,20}$/;
            return regex.test(username);
        }

        function checkPasswordStrength(password) {
            let strength = 0;
            const requirements = {
                length: password.length >= 8,
                lowercase: /[a-z]/.test(password),
                uppercase: /[A-Z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[^a-zA-Z0-9]/.test(password)
            };

            strength = Object.values(requirements).filter(req => req).length;

            return {
                strength: strength,
                requirements: requirements
            };
        }

        function updatePasswordRequirements(requirements) {
            const reqIds = ['length', 'lowercase', 'uppercase', 'number', 'special'];
            reqIds.forEach(id => {
                const element = document.getElementById(`${id}-req`);
                const icon = element.querySelector('i');
                
                if (requirements[id]) {
                    element.classList.add('valid');
                    element.classList.remove('invalid');
                    icon.className = 'fas fa-check';
                } else {
                    element.classList.add('invalid');
                    element.classList.remove('valid');
                    icon.className = 'fas fa-times';
                }
            });
        }

        function updatePasswordStrength(strength) {
            const strengthBar = document.getElementById('password-strength');
            strengthBar.className = 'password-strength';
            
            if (strength <= 2) {
                strengthBar.classList.add('weak');
            } else if (strength <= 4) {
                strengthBar.classList.add('medium');
            } else {
                strengthBar.classList.add('strong');
            }
        }

        function validateRegistrationForm() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            const isUsernameValid = validateUsername(username);
            const passwordCheck = checkPasswordStrength(password);
            const isPasswordValid = passwordCheck.strength >= 3;
            const isConfirmValid = password === confirmPassword && password !== '';
            
            document.getElementById('register-username').className = isUsernameValid ? 'valid' : 'invalid';
            document.getElementById('register-password').className = isPasswordValid ? 'valid' : 'invalid';
            document.getElementById('confirm-password').className = isConfirmValid ? 'valid' : 'invalid';
            
            document.getElementById('register-btn').disabled = !(isUsernameValid && isPasswordValid && isConfirmValid);
            
            return isUsernameValid && isPasswordValid && isConfirmValid;
        }

        function validateLoginForm() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            const isUsernameValid = username.length >= 3;
            const isPasswordValid = password.length >= 1;
            
            document.getElementById('login-username').className = isUsernameValid ? 'valid' : 'invalid';
            document.getElementById('login-password').className = isPasswordValid ? 'valid' : 'invalid';
            
            document.getElementById('login-username-error').style.display = isUsernameValid ? 'none' : 'flex';
            document.getElementById('login-password-error').style.display = isPasswordValid ? 'none' : 'flex';
            
            document.getElementById('login-btn').disabled = !(isUsernameValid && isPasswordValid);
            
            return isUsernameValid && isPasswordValid;
        }

        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏
        function formatLastSeen(lastSeen) {
            if (!lastSeen) return '–Ω–∏–∫–æ–≥–¥–∞';
            
            const now = new Date();
            const lastSeenDate = new Date(lastSeen);
            const diffMs = now - lastSeenDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
            if (diffDays < 7) return `${diffDays} –¥ –Ω–∞–∑–∞–¥`;
            
            return lastSeenDate.toLocaleDateString('ru-RU');
        }

        function isUserOnline(lastSeen) {
            if (!lastSeen) return false;
            const now = new Date();
            const lastSeenDate = new Date(lastSeen);
            return (now - lastSeenDate) < 300000; // 5 –º–∏–Ω—É—Ç
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–æ–π
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('wavechat_theme', theme);
        }

        function getTheme() {
            return localStorage.getItem('wavechat_theme') || 'dark';
        }

        // Ripple —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∫–Ω–æ–ø–æ–∫
        function createRipple(event) {
            const button = event.currentTarget;
            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - button.getBoundingClientRect().left - radius}px`;
            circle.style.top = `${event.clientY - button.getBoundingClientRect().top - radius}px`;
            circle.classList.add('ripple');

            const ripple = button.getElementsByClassName('ripple')[0];
            if (ripple) {
                ripple.remove();
            }

            button.appendChild(circle);
        }

        // –ö—Ä–∞—Å–∏–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const db = new WaveChatDB();
        let currentUser = null;
        let currentChat = null;
        let updateInterval = null;
        let editingMessageId = null;
        let messageToDelete = null;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let recordingStartTime = null;
        let isInCall = false;
        let callTimer = null;
        let callStartTime = null;
        let isMicrophoneMuted = false;
        let isCameraOff = false;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const landingPage = document.getElementById('landing-page');
        const authContainer = document.getElementById('auth-container');
        const messengerContainer = document.getElementById('messenger-container');
        const settingsModal = document.getElementById('settings-modal');
        const mediaModal = document.getElementById('media-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const callContainer = document.getElementById('call-container');
        const mobileMenu = document.getElementById('mobile-menu');
        const drawingContainer = document.getElementById('drawing-container');
        const drawingCanvas = document.getElementById('drawing-canvas');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        let isDrawing = false;
        let currentShape = 'line';
        let currentColor = '#0066FF';
        let startX, startY;
        let ctx = drawingCanvas.getContext('2d');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function playVoiceMessage(url) {
            try {
                const audio = new Audio(url);
                audio.play().catch(e => {
                    console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ:", e);
                    showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ", "error");
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                audio.addEventListener('ended', function() {
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
                    console.log("–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ");
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                showNotification("–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è", "info");
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—É–¥–∏–æ:", error);
                showNotification("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è", "error");
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        function toggleMicrophone() {
            isMicrophoneMuted = !isMicrophoneMuted;
            const muteBtn = document.getElementById('mute-call-btn');
            
            if (isMicrophoneMuted) {
                muteBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                muteBtn.classList.add('muted');
                showNotification('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω', 'info');
            } else {
                muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                muteBtn.classList.remove('muted');
                showNotification('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω', 'info');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
        function toggleCamera() {
            isCameraOff = !isCameraOff;
            const videoBtn = document.getElementById('video-toggle-btn');
            
            if (isCameraOff) {
                videoBtn.innerHTML = '<i class="fas fa-video-slash"></i>';
                videoBtn.classList.add('off');
                showNotification('–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞', 'info');
            } else {
                videoBtn.innerHTML = '<i class="fas fa-video"></i>';
                videoBtn.classList.remove('off');
                showNotification('–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞', 'info');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ WaveChat –∑–∞–≥—Ä—É–∂–µ–Ω!');
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
            const savedTheme = getTheme();
            setTheme(savedTheme);
            document.getElementById('theme-toggle').checked = savedTheme === 'light';
            document.getElementById('mobile-theme-toggle').checked = savedTheme === 'light';
            document.getElementById('theme-setting').checked = savedTheme === 'light';
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é
            currentUser = db.restoreSession();
            if (currentUser) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏–º –≤ —Å–∏—Å—Ç–µ–º—É
                messengerContainer.style.display = 'block';
                landingPage.style.display = 'none';
                authContainer.style.display = 'none';
                
                document.getElementById('user-avatar').textContent = currentUser.avatar;
                document.getElementById('user-name').textContent = currentUser.username;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∞–≤–∞—Ç–∞—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
                if (currentUser.customAvatar) {
                    document.getElementById('user-avatar').style.backgroundImage = `url(${currentUser.customAvatar})`;
                    document.getElementById('user-avatar').textContent = '';
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ–±–æ–∏
                applyWallpaper();
                
                loadUserChats();
                startOnlineUpdates();
                showNotification(`–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${currentUser.username}!`, 'success');
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                landingPage.style.display = 'block';
                authContainer.style.display = 'none';
                messengerContainer.style.display = 'none';
            }

            // –î–æ–±–∞–≤–ª—è–µ–º ripple —ç—Ñ—Ñ–µ–∫—Ç –∫–æ –≤—Å–µ–º –∫–Ω–æ–ø–∫–∞–º
            const buttons = document.querySelectorAll('.btn-3d, .auth-btn, .action-btn, .send-btn, .close-modal');
            buttons.forEach(button => {
                button.addEventListener('click', createRipple);
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ —Ç–µ–º—ã
            document.getElementById('theme-toggle').addEventListener('change', function() {
                const theme = this.checked ? 'light' : 'dark';
                setTheme(theme);
                document.getElementById('mobile-theme-toggle').checked = this.checked;
                document.getElementById('theme-setting').checked = this.checked;
            });

            document.getElementById('mobile-theme-toggle').addEventListener('change', function() {
                const theme = this.checked ? 'light' : 'dark';
                setTheme(theme);
                document.getElementById('theme-toggle').checked = this.checked;
                document.getElementById('theme-setting').checked = this.checked;
                mobileMenu.classList.remove('active');
            });

            document.getElementById('theme-setting').addEventListener('change', function() {
                const theme = this.checked ? 'light' : 'dark';
                setTheme(theme);
                document.getElementById('theme-toggle').checked = this.checked;
                document.getElementById('mobile-theme-toggle').checked = this.checked;
            });

            // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
            document.getElementById('mobile-menu-btn').addEventListener('click', function() {
                mobileMenu.classList.add('active');
            });

            document.getElementById('mobile-menu-close').addEventListener('click', function() {
                mobileMenu.classList.remove('active');
            });

            document.getElementById('mobile-login-btn').addEventListener('click', function() {
                mobileMenu.classList.remove('active');
                landingPage.style.display = 'none';
                authContainer.style.display = 'flex';
            });

            document.getElementById('mobile-register-btn').addEventListener('click', function() {
                mobileMenu.classList.remove('active');
                landingPage.style.display = 'none';
                authContainer.style.display = 'flex';
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.getElementById('landing-login-btn').addEventListener('click', function() {
                landingPage.style.display = 'none';
                authContainer.style.display = 'flex';
            });

            document.getElementById('landing-register-btn').addEventListener('click', function() {
                landingPage.style.display = 'none';
                authContainer.style.display = 'flex';
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            });

            document.getElementById('hero-register-btn').addEventListener('click', function() {
                landingPage.style.display = 'none';
                authContainer.style.display = 'flex';
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            });

            document.getElementById('learn-more-btn').addEventListener('click', function() {
                showNotification('WaveChat - —ç—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º, –±—ã—Å—Ç—Ä–æ–π –¥–æ—Å—Ç–∞–≤–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —É–¥–æ–±–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º!', 'info');
            });

            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            document.getElementById('auth-back-btn').addEventListener('click', function() {
                authContainer.style.display = 'none';
                landingPage.style.display = 'block';
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞–º–∏ –≤—Ö–æ–¥–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('switch-to-register').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('login-form').style.display = 'none';
                document.getElementById('register-form').style.display = 'block';
            });

            document.getElementById('switch-to-login').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('register-form').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
            });

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            document.getElementById('register-username').addEventListener('input', async function() {
                const username = this.value;
                const isValid = validateUsername(username);
                
                document.getElementById('register-username-error').style.display = isValid ? 'none' : 'flex';
                
                if (isValid) {
                    const existingUser = await db.getUserByUsername(username);
                    if (existingUser) {
                        document.getElementById('register-username-error').textContent = '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ';
                        document.getElementById('register-username-error').style.display = 'flex';
                        document.getElementById('register-username-success').style.display = 'none';
                        this.className = 'invalid';
                    } else {
                        document.getElementById('register-username-success').style.display = 'flex';
                        this.className = 'valid';
                    }
                } else {
                    document.getElementById('register-username-success').style.display = 'none';
                }
                
                validateRegistrationForm();
            });

            document.getElementById('register-password').addEventListener('input', function() {
                const password = this.value;
                const passwordCheck = checkPasswordStrength(password);
                
                updatePasswordRequirements(passwordCheck.requirements);
                updatePasswordStrength(passwordCheck.strength);
                
                document.getElementById('register-password-error').style.display = 
                    passwordCheck.strength >= 3 ? 'none' : 'flex';
                
                validateRegistrationForm();
            });

            document.getElementById('confirm-password').addEventListener('input', function() {
                const password = document.getElementById('register-password').value;
                const confirmPassword = this.value;
                
                const isValid = password === confirmPassword && password !== '';
                
                document.getElementById('confirm-password-error').style.display = isValid ? 'none' : 'flex';
                
                validateRegistrationForm();
            });

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
            document.getElementById('login-username').addEventListener('input', validateLoginForm);
            document.getElementById('login-password').addEventListener('input', validateLoginForm);

            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            document.getElementById('register-btn').addEventListener('click', async function() {
                if (!validateRegistrationForm()) {
                    showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ', 'error');
                    return;
                }

                const username = document.getElementById('register-username').value.trim();
                const password = document.getElementById('register-password').value;

                const existingUser = await db.getUserByUsername(username);
                if (existingUser) {
                    showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
                    return;
                }

                const user = {
                    id: 'user_' + Date.now(),
                    username: username,
                    password: password,
                    avatar: username.substring(0, 2).toUpperCase(),
                    isOnline: true,
                    lastSeen: new Date().toISOString(),
                    customAvatar: null
                };

                await db.addUser(user);
                currentUser = user;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                await db.saveSettings(currentUser.id, {
                    theme: getTheme(),
                    notifications: 'all',
                    wallpaper: 'default'
                });
                
                authContainer.style.display = 'none';
                messengerContainer.style.display = 'block';
                
                document.getElementById('user-avatar').textContent = currentUser.avatar;
                document.getElementById('user-name').textContent = currentUser.username;
                
                await loadUserChats();
                startOnlineUpdates();
                
                showNotification('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ WaveChat!', 'success');
            });

            // –í—Ö–æ–¥
            document.getElementById('login-btn').addEventListener('click', async function() {
                if (!validateLoginForm()) {
                    showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ', 'error');
                    return;
                }

                const username = document.getElementById('login-username').value.trim();
                const password = document.getElementById('login-password').value;

                const user = await db.getUserByUsername(username);
                if (!user || user.password !== password) {
                    showNotification('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
                    return;
                }

                currentUser = user;
                await db.updateUser(user.id, { 
                    isOnline: true,
                    lastSeen: new Date().toISOString()
                });
                
                db.saveSession(currentUser); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
                
                authContainer.style.display = 'none';
                messengerContainer.style.display = 'block';
                
                document.getElementById('user-avatar').textContent = currentUser.avatar;
                document.getElementById('user-name').textContent = currentUser.username;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∞–≤–∞—Ç–∞—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
                if (currentUser.customAvatar) {
                    document.getElementById('user-avatar').style.backgroundImage = `url(${currentUser.customAvatar})`;
                    document.getElementById('user-avatar').textContent = '';
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ–±–æ–∏
                applyWallpaper();
                
                await loadUserChats();
                startOnlineUpdates();
                
                showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}!`, 'success');
            });

            // –í—ã—Ö–æ–¥
            document.getElementById('logout-btn').addEventListener('click', async function() {
                if (currentUser) {
                    await db.updateUser(currentUser.id, { 
                        isOnline: false,
                        lastSeen: new Date().toISOString()
                    });
                    db.clearSession();
                }
                
                currentUser = null;
                currentChat = null;
                messengerContainer.style.display = 'none';
                landingPage.style.display = 'block';
                
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
                
                // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
                document.getElementById('register-username').value = '';
                document.getElementById('register-password').value = '';
                document.getElementById('confirm-password').value = '';
                
                showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'info');
            });

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            document.getElementById('settings-btn').addEventListener('click', async function() {
                if (!currentUser) return;
                
                const settings = await db.getSettings(currentUser.id);
                document.getElementById('notifications-setting').value = settings.notifications || 'all';
                document.getElementById('username-setting').value = currentUser.username;
                
                // –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–≤–∞—Ç–∞—Ä
                document.querySelectorAll('.avatar-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.avatar === currentUser.avatar) {
                        option.classList.add('selected');
                    }
                });
                
                // –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ–±–æ–∏
                document.querySelectorAll('.wallpaper-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.wallpaper === (settings.wallpaper || 'default')) {
                        option.classList.add('selected');
                    }
                });
                
                settingsModal.style.display = 'flex';
            });

            // –í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∞
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // –í—ã–±–æ—Ä –æ–±–æ–µ–≤
            document.querySelectorAll('.wallpaper-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.wallpaper-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏
            document.getElementById('avatar-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB', 'error');
                        return;
                    }
                    
                    if (!file.type.startsWith('image/')) {
                        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const avatarUrl = event.target.result;
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∞–≤–∞—Ç–∞—Ä–∞
                        const newAvatarOption = document.createElement('div');
                        newAvatarOption.className = 'avatar-option selected';
                        newAvatarOption.style.backgroundImage = `url(${avatarUrl})`;
                        newAvatarOption.title = '–í–∞—à–∞ –∞–≤–∞—Ç–∞—Ä–∫–∞';
                        
                        // –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∞–≤–∞—Ç–∞—Ä—ã
                        const avatarOptions = document.querySelector('.avatar-options');
                        avatarOptions.innerHTML = '';
                        avatarOptions.appendChild(newAvatarOption);
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        currentUser.customAvatar = avatarUrl;
                        currentUser.avatar = 'IMG'; // –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Ä—Ç–∏–Ω–∫–∞
                        db.updateUser(currentUser.id, {
                            customAvatar: avatarUrl,
                            avatar: 'IMG'
                        });
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
                        document.getElementById('user-avatar').style.backgroundImage = `url(${avatarUrl})`;
                        document.getElementById('user-avatar').textContent = '';
                        
                        showNotification('–ê–≤–∞—Ç–∞—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–æ–µ–≤
            document.getElementById('wallpaper-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 10 * 1024 * 1024) { // 10MB limit
                        showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB', 'error');
                        return;
                    }
                    
                    if (!file.type.startsWith('image/')) {
                        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const wallpaperUrl = event.target.result;
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –æ–±–æ–µ–≤
                        const newWallpaperOption = document.createElement('div');
                        newWallpaperOption.className = 'wallpaper-option selected';
                        newWallpaperOption.style.backgroundImage = `url(${wallpaperUrl})`;
                        newWallpaperOption.dataset.wallpaper = 'custom';
                        newWallpaperOption.innerHTML = '<span class="wallpaper-name">–ú–æ–∏ –æ–±–æ–∏</span>';
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±–æ–∏ –≤ —Å–ø–∏—Å–æ–∫
                        const wallpaperOptions = document.querySelector('.wallpaper-options');
                        wallpaperOptions.appendChild(newWallpaperOption);
                        
                        // –í—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–µ –æ–±–æ–∏
                        document.querySelectorAll('.wallpaper-option').forEach(option => {
                            option.classList.remove('selected');
                        });
                        newWallpaperOption.classList.add('selected');
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–æ–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
                        db.saveSettings(currentUser.id, {
                            wallpaper: 'custom',
                            customWallpaper: wallpaperUrl
                        });
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–æ–∏
                        applyWallpaper('custom', wallpaperUrl);
                        
                        showNotification('–û–±–æ–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('save-settings-btn').addEventListener('click', async function() {
                if (!currentUser) return;
                
                const notifications = document.getElementById('notifications-setting').value;
                const selectedAvatar = document.querySelector('.avatar-option.selected');
                const selectedWallpaper = document.querySelector('.wallpaper-option.selected');
                const newUsername = document.getElementById('username-setting').value.trim();
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (newUsername && newUsername !== currentUser.username) {
                    if (!validateUsername(newUsername)) {
                        document.getElementById('username-error').style.display = 'flex';
                        return;
                    }
                    
                    const existingUser = await db.getUserByUsername(newUsername);
                    if (existingUser) {
                        document.getElementById('username-error').textContent = '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ';
                        document.getElementById('username-error').style.display = 'flex';
                        return;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    currentUser.username = newUsername;
                    await db.updateUser(currentUser.id, {
                        username: newUsername
                    });
                    
                    document.getElementById('user-name').textContent = newUsername;
                }
                
                document.getElementById('username-error').style.display = 'none';
                
                if (selectedAvatar && selectedAvatar.dataset.avatar) {
                    currentUser.avatar = selectedAvatar.dataset.avatar;
                    currentUser.customAvatar = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∞–≤–∞—Ç–∞—Ä–∫—É
                    await db.updateUser(currentUser.id, {
                        avatar: currentUser.avatar,
                        customAvatar: null
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    document.getElementById('user-avatar').style.backgroundImage = '';
                    document.getElementById('user-avatar').textContent = currentUser.avatar;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–æ–∏
                const wallpaper = selectedWallpaper ? selectedWallpaper.dataset.wallpaper : 'default';
                await db.saveSettings(currentUser.id, {
                    notifications: notifications,
                    wallpaper: wallpaper
                });
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–æ–∏
                applyWallpaper(wallpaper);
                
                settingsModal.style.display = 'none';
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
            });

            document.getElementById('clear-data-btn').addEventListener('click', function() {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                    db.clearDatabase();
                    showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã!', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                }
            });

            document.getElementById('cancel-settings-btn').addEventListener('click', function() {
                settingsModal.style.display = 'none';
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.querySelector('.close-modal').addEventListener('click', function() {
                settingsModal.style.display = 'none';
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–µ–¥–∏–∞
            document.getElementById('media-modal-close').addEventListener('click', function() {
                mediaModal.style.display = 'none';
            });

            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
            document.getElementById('confirm-cancel').addEventListener('click', function() {
                confirmModal.style.display = 'none';
                messageToDelete = null;
            });

            document.getElementById('confirm-delete').addEventListener('click', async function() {
                if (messageToDelete) {
                    await deleteMessage(messageToDelete);
                    messageToDelete = null;
                }
                confirmModal.style.display = 'none';
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
            document.getElementById('file-btn').addEventListener('click', function() {
                document.getElementById('file-input').click();
            });

            document.getElementById('file-input').addEventListener('change', function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    for (let file of files) {
                        sendFile(file);
                    }
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º input
                    this.value = '';
                }
            });

            // –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            document.getElementById('voice-btn').addEventListener('click', function() {
                if (!isRecording) {
                    startRecording();
                } else {
                    stopRecording();
                }
            });

            // –†–∏—Å–æ–≤–∞–Ω–∏–µ
            document.getElementById('draw-btn').addEventListener('click', function() {
                drawingContainer.style.display = 'block';
                initDrawingCanvas();
            });

            document.getElementById('close-drawing-btn').addEventListener('click', function() {
                drawingContainer.style.display = 'none';
            });

            document.getElementById('clear-drawing-btn').addEventListener('click', function() {
                clearDrawingCanvas();
            });

            document.getElementById('send-drawing-btn').addEventListener('click', function() {
                sendDrawing();
            });

            // –í—ã–±–æ—Ä —Ñ–æ—Ä–º—ã –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            document.querySelectorAll('.shape-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentShape = this.dataset.shape;
                });
            });

            // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentColor = this.dataset.color;
                });
            });

            // –ó–≤–æ–Ω–∫–∏
            document.getElementById('voice-call-btn').addEventListener('click', function() {
                if (!currentChat) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –∑–≤–æ–Ω–∫–∞', 'error');
                    return;
                }
                startCall('voice');
            });

            document.getElementById('video-call-btn').addEventListener('click', function() {
                if (!currentChat) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –∑–≤–æ–Ω–∫–∞', 'error');
                    return;
                }
                startCall('video');
            });

            document.getElementById('accept-call-btn').addEventListener('click', function() {
                acceptCall();
            });

            document.getElementById('decline-call-btn').addEventListener('click', function() {
                declineCall();
            });

            document.getElementById('end-call-btn').addEventListener('click', function() {
                endCall();
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤–æ–Ω–∫–æ–º
            document.getElementById('mute-call-btn').addEventListener('click', function() {
                toggleMicrophone();
            });
            
            document.getElementById('video-toggle-btn').addEventListener('click', function() {
                toggleCamera();
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
            document.getElementById('message-input').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // –ü–æ–∏—Å–∫
            let searchTimeout;
            document.getElementById('global-search').addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const searchTerm = this.value.trim();
                
                searchTimeout = setTimeout(async () => {
                    if (searchTerm.length === 0) {
                        await loadUserChats();
                        return;
                    }
                    
                    await searchUsers(searchTerm);
                }, 300);
            });

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', function() {
                if (currentUser) {
                    db.updateUser(currentUser.id, {
                        lastSeen: new Date().toISOString()
                    });
                }
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–Ω–≤–∞—Å–∞ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            initDrawingCanvas();
        });

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±–æ–µ–≤
        function applyWallpaper(wallpaper, customUrl = null) {
            if (!wallpaper) {
                const settings = db.getSettings(currentUser.id);
                wallpaper = settings.wallpaper || 'default';
                customUrl = settings.customWallpaper;
            }
            
            const chatContent = document.querySelector('.chat-content');
            const messengerBg = document.querySelector('.messenger-bg');
            
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±–æ–∏
            chatContent.style.backgroundImage = '';
            messengerBg.style.backgroundImage = '';
            
            switch(wallpaper) {
                case 'mountains':
                    chatContent.style.backgroundImage = 'url("https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80")';
                    break;
                case 'field':
                    chatContent.style.backgroundImage = 'url("https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80")';
                    break;
                case 'office':
                    chatContent.style.backgroundImage = 'url("https://images.unsplash.com/photo-1497366754035-f200968a6e72?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80")';
                    break;
                case 'tea':
                    chatContent.style.backgroundImage = 'url("https://images.unsplash.com/photo-1544787219-7f47ccb76574?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80")';
                    break;
                case 'beach':
                    chatContent.style.backgroundImage = 'url("https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80")';
                    break;
                case 'forest':
                    chatContent.style.backgroundImage = 'url("https://images.unsplash.com/photo-1448375240586-882707db888b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80")';
                    break;
                case 'night':
                    chatContent.style.backgroundImage = 'url("https://images.unsplash.com/photo-1532978379173-523e16f3717d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80")';
                    break;
                case 'custom':
                    if (customUrl) {
                        chatContent.style.backgroundImage = `url(${customUrl})`;
                    }
                    break;
                case 'empty':
                    chatContent.style.background = 'var(--input-blue)';
                    break;
                default:
                    chatContent.style.background = 'linear-gradient(135deg, var(--input-blue), var(--card-blue))';
                    break;
            }
            
            if (wallpaper !== 'default' && wallpaper !== 'empty') {
                chatContent.style.backgroundSize = 'cover';
                chatContent.style.backgroundPosition = 'center';
                chatContent.style.backgroundAttachment = 'fixed';
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Ç–∞–º–∏
        async function loadUserChats() {
            if (!currentUser) return;
            
            const container = document.getElementById('chats-list');
            const chats = await db.getUserChats(currentUser.id);
            
            container.innerHTML = '';
            
            if (chats.length === 0) {
                container.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-title">–ù–µ—Ç —á–∞—Ç–æ–≤</div>
                        <div class="welcome-subtitle">–ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç —Å –ø–æ–º–æ—â—å—é –ø–æ–∏—Å–∫–∞</div>
                    </div>
                `;
                return;
            }
            
            for (const chat of chats) {
                const otherUserId = chat.participants.find(id => id !== currentUser.id);
                const otherUser = await db.getUserById(otherUserId);
                const lastMessage = await db.getLastMessage(chat.id);
                
                if (!otherUser) continue;
                
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${currentChat === chat.id ? 'active' : ''}`;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
                let avatarContent = otherUser.avatar;
                let avatarStyle = '';
                if (otherUser.customAvatar) {
                    avatarContent = '';
                    avatarStyle = `background-image: url(${otherUser.customAvatar})`;
                }
                
                chatItem.innerHTML = `
                    <div class="avatar ${isUserOnline(otherUser.lastSeen) ? 'online' : ''}" style="${avatarStyle}">${avatarContent}</div>
                    <div class="chat-info">
                        <div class="chat-name">
                            ${otherUser.username}
                        </div>
                        <div class="last-message">${lastMessage?.text || '–ß–∞—Ç –Ω–∞—á–∞—Ç'}</div>
                    </div>
                    <div class="chat-time">${new Date(chat.lastMessageTime).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</div>
                `;
                
                chatItem.addEventListener('click', function() {
                    loadChat(chat.id);
                });
                
                container.appendChild(chatItem);
            }
        }

        async function searchUsers(query) {
            const users = await db.searchUsers(query);
            const filteredUsers = users.filter(user => user.id !== currentUser.id);
            displaySearchResults(filteredUsers);
        }

        function displaySearchResults(users) {
            const container = document.getElementById('chats-list');
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 20px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            users.forEach(user => {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
                let avatarContent = user.avatar;
                let avatarStyle = '';
                if (user.customAvatar) {
                    avatarContent = '';
                    avatarStyle = `background-image: url(${user.customAvatar})`;
                }
                
                const userItem = document.createElement('div');
                userItem.className = 'chat-item';
                userItem.innerHTML = `
                    <div class="avatar ${isUserOnline(user.lastSeen) ? 'online' : ''}" style="${avatarStyle}">${avatarContent}</div>
                    <div class="chat-info">
                        <div class="chat-name">
                            ${user.username}
                        </div>
                        <div class="last-message">
                            ${isUserOnline(user.lastSeen) ? '–æ–Ω–ª–∞–π–Ω' : `–±—ã–ª(–∞) ${formatLastSeen(user.lastSeen)}`}
                        </div>
                    </div>
                    <div class="unread-badge">–ß–∞—Ç</div>
                `;
                
                userItem.addEventListener('click', function() {
                    startChatWithUser(user.id);
                    document.getElementById('global-search').value = '';
                });
                
                container.appendChild(userItem);
            });
        }

        async function startChatWithUser(userId) {
            let chat = await db.findChatBetweenUsers(currentUser.id, userId);
            
            if (!chat) {
                const otherUser = await db.getUserById(userId);
                chat = {
                    id: 'chat_' + Date.now(),
                    participants: [currentUser.id, userId],
                    participantNames: {
                        [currentUser.id]: currentUser.username,
                        [userId]: otherUser.username
                    },
                    lastMessage: '',
                    lastMessageTime: new Date().toISOString()
                };
                await db.addChat(chat);
            }
            
            await loadChat(chat.id);
            await loadUserChats();
        }

        async function loadChat(chatId) {
            currentChat = chatId;
            const chat = await db.getChat(chatId);
            
            const otherUserId = chat.participants.find(id => id !== currentUser.id);
            const otherUser = await db.getUserById(otherUserId);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
            let avatarContent = otherUser.avatar;
            let avatarStyle = '';
            if (otherUser.customAvatar) {
                avatarContent = '';
                avatarStyle = `background-image: url(${otherUser.customAvatar})`;
            }
            
            document.getElementById('current-chat-avatar').style = avatarStyle;
            document.getElementById('current-chat-avatar').textContent = avatarContent;
            document.getElementById('current-chat-avatar').className = `avatar ${isUserOnline(otherUser.lastSeen) ? 'online' : ''}`;
            document.getElementById('current-chat-name').textContent = otherUser.username;
            
            // –§–ò–ö–°: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            const statusText = isUserOnline(otherUser.lastSeen) ? 
                '<span class="status-dot"></span> –æ–Ω–ª–∞–π–Ω' : 
                `–±—ã–ª(–∞) ${formatLastSeen(otherUser.lastSeen)}`;
            document.getElementById('current-chat-status').innerHTML = statusText;
            
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            
            await loadChatMessages(chatId);
        }

        async function loadChatMessages(chatId) {
            const container = document.getElementById('chat-messages');
            const messages = await db.getChatMessages(chatId);
            
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-title">–ß–∞—Ç –Ω–∞—á–∞—Ç</div>
                        <div class="welcome-subtitle">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</div>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                addMessageToChat(message, false);
            });
            
            scrollToBottom();
        }

        function addMessageToChat(message, animate = true) {
            const container = document.getElementById('chat-messages');
            const isSent = message.senderId === currentUser.id;
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isSent ? 'sent' : 'received'} ${message.uploading ? 'uploading' : ''} ${message.editing ? 'editing' : ''}`;
            messageElement.dataset.messageId = message.id;
            
            const time = new Date(message.timestamp).toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let messageContent = message.text;
            
            // –ï—Å–ª–∏ —ç—Ç–æ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (message.voice) {
                messageContent = `
                    <div>${message.text || ''}</div>
                    <div class="voice-message-container">
                        <button class="voice-play-btn" onclick="playVoiceMessage('${message.voice.url}')">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="voice-waveform">
                            <div class="voice-wave">
                                ${generateVoiceWaveform()}
                            </div>
                        </div>
                        <div class="voice-duration">${message.voice.duration || '0:05'}</div>
                    </div>
                `;
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ —Ä–∏—Å—É–Ω–æ–∫
            if (message.drawing) {
                messageContent = `
                    <div>${message.text || ''}</div>
                    <img src="${message.drawing.url}" alt="–†–∏—Å—É–Ω–æ–∫" class="media-content image-message" onclick="openMediaModal('${message.drawing.url}')">
                `;
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (message.image) {
                messageContent = `
                    <div>${message.text || ''}</div>
                    <img src="${message.image.url}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="media-content image-message" onclick="openMediaModal('${message.image.url}')">
                `;
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ –≤–∏–¥–µ–æ
            if (message.video) {
                messageContent = `
                    <div>${message.text || ''}</div>
                    <video controls class="media-content video-message">
                        <source src="${message.video.url}" type="${message.video.type}">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                    </video>
                `;
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ —Ñ–∞–π–ª
            if (message.file) {
                messageContent = `
                    <div>${message.text || '–§–∞–π–ª'}</div>
                    <div class="file-message">
                        <div class="file-icon">
                            <i class="fas fa-${getFileIcon(message.file.type)}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">${message.file.name}</div>
                            <div class="file-size">${formatFileSize(message.file.size)}</div>
                        </div>
                        <button class="download-btn" onclick="downloadFile('${message.file.url}', '${message.file.name}')">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
            }
            
            // –ï—Å–ª–∏ —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
            if (message.uploading) {
                messageContent = `
                    <div class="message-content">
                        <div class="spinner"></div>
                        <div>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</div>
                    </div>
                    <div class="upload-progress">
                        <div class="upload-progress-bar" style="width: ${message.progress || 0}%"></div>
                    </div>
                `;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            const actionsHtml = isSent ? `
                <div class="message-actions">
                    <button class="message-action edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onclick="editMessage('${message.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="message-action delete" title="–£–¥–∞–ª–∏—Ç—å" onclick="showDeleteConfirm('${message.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            ` : '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const editedIndicator = message.edited ? '<span class="edited-indicator">(–∏–∑–º–µ–Ω–µ–Ω–æ)</span>' : '';
            
            messageElement.innerHTML = `
                ${actionsHtml}
                <div>${messageContent}</div>
                <div class="message-time">${time} ${editedIndicator}</div>
                ${isSent ? '<div class="message-status"><i class="fas fa-check-double"></i> –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</div>' : ''}
            `;
            
            if (animate) {
                messageElement.style.animation = 'messageAppear 0.4s ease-out';
            }
            
            container.appendChild(messageElement);
            scrollToBottom();
        }

        function generateVoiceWaveform() {
            let waveform = '';
            for (let i = 0; i < 20; i++) {
                const height = Math.floor(Math.random() * 20) + 5;
                waveform += `<div class="voice-bar" style="height: ${height}px;"></div>`;
            }
            return waveform;
        }

        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return 'file-image';
            if (fileType.startsWith('video/')) return 'file-video';
            if (fileType.startsWith('audio/')) return 'file-audio';
            if (fileType.includes('pdf')) return 'file-pdf';
            if (fileType.includes('word')) return 'file-word';
            if (fileType.includes('excel')) return 'file-excel';
            if (fileType.includes('zip')) return 'file-archive';
            return 'file';
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || !currentChat) return;
            
            // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (editingMessageId) {
                await db.updateMessage(editingMessageId, {
                    text: text,
                    edited: true
                });
                
                editingMessageId = null;
                input.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...';
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const message = {
                    id: 'msg_' + Date.now(),
                    chatId: currentChat,
                    senderId: currentUser.id,
                    text: text,
                    timestamp: new Date().toISOString(),
                    edited: false
                };
                
                await db.addMessage(message);
            }
            
            await db.updateChat(currentChat, {
                lastMessage: text,
                lastMessageTime: new Date().toISOString()
            });
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            await loadChatMessages(currentChat);
            input.value = '';
            input.style.height = 'auto';
            await loadUserChats();
        }

        async function sendFile(file) {
            if (!currentChat) return;
            
            // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
            const message = {
                id: 'msg_' + Date.now(),
                chatId: currentChat,
                senderId: currentUser.id,
                text: '',
                timestamp: new Date().toISOString(),
                uploading: true,
                progress: 0,
                edited: false
            };
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            if (file.type.startsWith('image/')) {
                message.image = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    url: URL.createObjectURL(file)
                };
            } else if (file.type.startsWith('video/')) {
                message.video = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    url: URL.createObjectURL(file)
                };
            } else {
                message.file = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    url: URL.createObjectURL(file)
                };
            }
            
            addMessageToChat(message, true);
            
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(progressInterval);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ "–∑–∞–≥—Ä—É–∑–∫–∏"
                    message.uploading = false;
                    message.progress = 100;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–∞–∑—É
                    db.addMessage(message);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç
                    db.updateChat(currentChat, {
                        lastMessage: `–§–∞–π–ª: ${file.name}`,
                        lastMessageTime: new Date().toISOString()
                    });
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                    loadChatMessages(currentChat);
                    loadUserChats();
                } else {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    message.progress = progress;
                    const messageElement = document.querySelector(`[data-message-id="${message.id}"]`);
                    if (messageElement) {
                        const progressBar = messageElement.querySelector('.upload-progress-bar');
                        if (progressBar) {
                            progressBar.style.width = progress + '%';
                        }
                    }
                }
            }, 200);
        }

        // –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –∞—É–¥–∏–æ', 'error');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    isRecording = true;
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        sendVoiceMessage(audioUrl);
                        
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    document.getElementById('voice-btn').innerHTML = '<i class="fas fa-stop"></i>';
                    document.getElementById('voice-btn').style.background = 'linear-gradient(135deg, var(--error-red), #cc3333)';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
                    const recordingIndicator = document.createElement('div');
                    recordingIndicator.className = 'recording-indicator';
                    recordingIndicator.id = 'recording-indicator';
                    recordingIndicator.innerHTML = `
                        <div class="recording-dot"></div>
                        <div class="recording-text">–ó–∞–ø–∏—Å—å...</div>
                        <div class="recording-timer" id="recording-timer">0:00</div>
                    `;
                    
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.appendChild(recordingIndicator);
                    scrollToBottom();
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                    recordingStartTime = new Date();
                    recordingTimer = setInterval(updateRecordingTimer, 1000);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
                });
        }

        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            
            isRecording = false;
            mediaRecorder.stop();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('voice-btn').innerHTML = '<i class="fas fa-microphone"></i>';
            document.getElementById('voice-btn').style.background = '';
            
            // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
            const recordingIndicator = document.getElementById('recording-indicator');
            if (recordingIndicator) {
                recordingIndicator.remove();
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
        }

        function updateRecordingTimer() {
            if (!recordingStartTime) return;
            
            const now = new Date();
            const diff = Math.floor((now - recordingStartTime) / 1000);
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            
            const timerElement = document.getElementById('recording-timer');
            if (timerElement) {
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã
            if (diff >= 120) {
                stopRecording();
            }
        }

        async function sendVoiceMessage(audioUrl) {
            if (!currentChat) return;
            
            const duration = '0:' + Math.floor((new Date() - recordingStartTime) / 1000).toString().padStart(2, '0');
            
            const message = {
                id: 'msg_' + Date.now(),
                chatId: currentChat,
                senderId: currentUser.id,
                text: '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                timestamp: new Date().toISOString(),
                voice: {
                    url: audioUrl,
                    duration: duration
                },
                edited: false
            };
            
            await db.addMessage(message);
            
            await db.updateChat(currentChat, {
                lastMessage: '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                lastMessageTime: new Date().toISOString()
            });
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            await loadChatMessages(currentChat);
            await loadUserChats();
        }

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ
        function initDrawingCanvas() {
            ctx.fillStyle = 'var(--input-blue)';
            ctx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);
            
            // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ touch —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            drawingCanvas.addEventListener('touchstart', handleTouchStart);
            drawingCanvas.addEventListener('touchmove', handleTouchMove);
            drawingCanvas.addEventListener('touchend', stopDrawing);
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            drawingCanvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            drawingCanvas.dispatchEvent(mouseEvent);
        }

        function startDrawing(e) {
            isDrawing = true;
            startX = e.offsetX;
            startY = e.offsetY;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const currentX = e.offsetX;
            const currentY = e.offsetY;
            
            ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            ctx.fillStyle = 'var(--input-blue)';
            ctx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            
            ctx.strokeStyle = currentColor;
            ctx.fillStyle = currentColor;
            ctx.lineWidth = 2;
            
            switch(currentShape) {
                case 'line':
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(currentX, currentY);
                    ctx.stroke();
                    break;
                case 'circle':
                    const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
                    ctx.beginPath();
                    ctx.arc(startX, startY, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    break;
                case 'rectangle':
                    const width = currentX - startX;
                    const height = currentY - startY;
                    ctx.strokeRect(startX, startY, width, height);
                    break;
                case 'triangle':
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(currentX, currentY);
                    ctx.lineTo(startX * 2 - currentX, currentY);
                    ctx.closePath();
                    ctx.stroke();
                    break;
                case 'star':
                    drawStar(startX, startY, 5, 30, 15);
                    break;
                case 'heart':
                    drawHeart(startX, startY, 30);
                    break;
            }
        }

        function drawStar(cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let x = cx;
            let y = cy;
            let step = Math.PI / spikes;

            ctx.beginPath();
            ctx.moveTo(cx, cy - outerRadius);
            
            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius;
                y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y);
                rot += step;

                x = cx + Math.cos(rot) * innerRadius;
                y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y);
                rot += step;
            }
            
            ctx.lineTo(cx, cy - outerRadius);
            ctx.closePath();
            ctx.stroke();
        }

        function drawHeart(x, y, size) {
            ctx.beginPath();
            const topCurveHeight = size * 0.3;
            ctx.moveTo(x, y + size / 4);
            // –í–µ—Ä—Ö–Ω—è—è –ª–µ–≤–∞—è –∫—Ä–∏–≤–∞—è
            ctx.bezierCurveTo(
                x, y, 
                x - size / 2, y, 
                x - size / 2, y + size / 4
            );
            // –ù–∏–∂–Ω—è—è –ª–µ–≤–∞—è –∫—Ä–∏–≤–∞—è
            ctx.bezierCurveTo(
                x - size / 2, y + size / 2, 
                x, y + size, 
                x, y + size
            );
            // –ù–∏–∂–Ω—è—è –ø—Ä–∞–≤–∞—è –∫—Ä–∏–≤–∞—è
            ctx.bezierCurveTo(
                x, y + size, 
                x + size / 2, y + size / 2, 
                x + size / 2, y + size / 4
            );
            // –í–µ—Ä—Ö–Ω—è—è –ø—Ä–∞–≤–∞—è –∫—Ä–∏–≤–∞—è
            ctx.bezierCurveTo(
                x + size / 2, y, 
                x, y, 
                x, y + size / 4
            );
            ctx.closePath();
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearDrawingCanvas() {
            ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            ctx.fillStyle = 'var(--input-blue)';
            ctx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        }

        async function sendDrawing() {
            if (!currentChat) return;
            
            const dataUrl = drawingCanvas.toDataURL('image/png');
            
            const message = {
                id: 'msg_' + Date.now(),
                chatId: currentChat,
                senderId: currentUser.id,
                text: '–†–∏—Å—É–Ω–æ–∫',
                timestamp: new Date().toISOString(),
                drawing: {
                    url: dataUrl
                },
                edited: false
            };
            
            await db.addMessage(message);
            
            await db.updateChat(currentChat, {
                lastMessage: '–†–∏—Å—É–Ω–æ–∫',
                lastMessageTime: new Date().toISOString()
            });
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            await loadChatMessages(currentChat);
            await loadUserChats();
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            drawingContainer.style.display = 'none';
            clearDrawingCanvas();
            
            showNotification('–†–∏—Å—É–Ω–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
        }

        // –ó–≤–æ–Ω–∫–∏
        function startCall(type) {
            if (isInCall) {
                showNotification('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫', 'error');
                return;
            }
            
            isInCall = true;
            const callType = type === 'video' ? '–≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫' : '–≥–æ–ª–æ—Å–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI –∑–≤–æ–Ω–∫–∞
            document.getElementById('call-avatar').textContent = document.getElementById('current-chat-avatar').textContent;
            document.getElementById('call-name').textContent = document.getElementById('current-chat-name').textContent;
            document.getElementById('call-status').textContent = `–ò—Å—Ö–æ–¥—è—â–∏–π ${callType}...`;
            
            document.getElementById('accept-call-btn').style.display = 'none';
            document.getElementById('decline-call-btn').style.display = 'none';
            document.getElementById('end-call-btn').style.display = 'flex';
            document.getElementById('mute-call-btn').style.display = 'flex';
            document.getElementById('video-toggle-btn').style.display = 'flex';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∑–≤–æ–Ω–∫–∞
            isMicrophoneMuted = false;
            isCameraOff = false;
            document.getElementById('mute-call-btn').classList.remove('muted');
            document.getElementById('video-toggle-btn').classList.remove('off');
            
            callContainer.style.display = 'flex';
            
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–≤–æ–Ω–æ–∫
            setTimeout(() => {
                if (isInCall) {
                    document.getElementById('call-status').textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...';
                    
                    setTimeout(() => {
                        if (isInCall) {
                            document.getElementById('call-status').textContent = '–ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç';
                            startCallTimer();
                        }
                    }, 2000);
                }
            }, 1000);
        }

        function acceptCall() {
            document.getElementById('call-status').textContent = '–ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç';
            document.getElementById('accept-call-btn').style.display = 'none';
            document.getElementById('decline-call-btn').style.display = 'none';
            document.getElementById('end-call-btn').style.display = 'flex';
            document.getElementById('mute-call-btn').style.display = 'flex';
            document.getElementById('video-toggle-btn').style.display = 'flex';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–≤–æ–Ω–∫–∞
            isMicrophoneMuted = false;
            isCameraOff = false;
            document.getElementById('mute-call-btn').classList.remove('muted');
            document.getElementById('video-toggle-btn').classList.remove('off');
            
            startCallTimer();
        }

        function declineCall() {
            endCall();
            showNotification('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω', 'info');
        }

        function endCall() {
            isInCall = false;
            callContainer.style.display = 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('mute-call-btn').style.display = 'none';
            document.getElementById('video-toggle-btn').style.display = 'none';
            
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
        }

        function startCallTimer() {
            callStartTime = new Date();
            callTimer = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - callStartTime) / 1000);
                const minutes = Math.floor(diff / 60);
                const seconds = diff % 60;
                
                document.getElementById('call-status').textContent = 
                    `–†–∞–∑–≥–æ–≤–æ—Ä: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function editMessage(messageId) {
            const message = await db.getMessages().find(m => m.id === messageId);
            if (!message) return;
            
            const input = document.getElementById('message-input');
            input.value = message.text;
            input.focus();
            input.placeholder = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è...';
            
            editingMessageId = messageId;
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ–ª—é –≤–≤–æ–¥–∞
            input.scrollIntoView({ behavior: 'smooth' });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
        function showDeleteConfirm(messageId) {
            messageToDelete = messageId;
            confirmModal.style.display = 'flex';
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function deleteMessage(messageId) {
            await db.deleteMessage(messageId);
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            await loadChatMessages(currentChat);
            await loadUserChats();
            
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
        }

        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function openMediaModal(url) {
            const modal = document.getElementById('media-modal');
            const content = document.getElementById('media-modal-content');
            
            content.src = url;
            modal.style.display = 'flex';
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω
        function startOnlineUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            updateInterval = setInterval(async () => {
                if (currentUser) {
                    await db.updateUser(currentUser.id, {
                        lastSeen: new Date().toISOString()
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ
                    if (currentChat) {
                        const chat = await db.getChat(currentChat);
                        const otherUserId = chat.participants.find(id => id !== currentUser.id);
                        const otherUser = await db.getUserById(otherUserId);
                        
                        if (otherUser) {
                            // –§–ò–ö–°: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å–∞
                            const isOnline = isUserOnline(otherUser.lastSeen);
                            const statusText = isOnline ? 
                                '<span class="status-dot"></span> –æ–Ω–ª–∞–π–Ω' : 
                                `–±—ã–ª(–∞) ${formatLastSeen(otherUser.lastSeen)}`;
                            document.getElementById('current-chat-status').innerHTML = statusText;
                            document.getElementById('current-chat-avatar').className = `avatar ${isOnline ? 'online' : ''}`;
                        }
                    }
                    
                    await loadUserChats();
                }
            }, 30000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        }
    </script>
</body>
</html>
