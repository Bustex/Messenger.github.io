<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥–Ω–∞—Ç - –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        :root {
            --primary-blue: #0066FF;
            --secondary-blue: #00D4FF;
            --dark-blue: #0A0F2D;
            --card-blue: #1A1F3E;
            --input-blue: #252A4A;
            --text-white: #FFFFFF;
            --text-gray: #A0A8D0;
            --accent-purple: #8A2BE2;
            --online-green: #00FF88;
            --idle-yellow: #FFAA00;
            --dnd-red: #FF4444;
            --offline-gray: #A0A8D0;
            --success-green: #00CC66;
            --warning-orange: #FFAA00;
            --shadow-blue: rgba(0, 102, 255, 0.3);
        }

        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
        [data-theme="light"] {
            --primary-blue: #0066FF;
            --secondary-blue: #00A3CC;
            --dark-blue: #F5F7FF;
            --card-blue: #FFFFFF;
            --input-blue: #F8F9FF;
            --text-white: #2D3748;
            --text-gray: #718096;
            --accent-purple: #8A2BE2;
            --online-green: #00CC66;
            --idle-yellow: #DD6B20;
            --dnd-red: #E53E3E;
            --offline-gray: #718096;
            --success-green: #38A169;
            --warning-orange: #DD6B20;
            --shadow-blue: rgba(0, 102, 255, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #151A3A 100%);
            color: var(--text-white);
            min-height: 100vh;
            overflow-x: hidden;
        }

        [data-theme="light"] body {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #E6EEFF 100%);
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        /* ... */

        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π */
        .permission-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .permission-content {
            background: linear-gradient(135deg, var(--card-blue), var(--input-blue));
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .permission-icon {
            font-size: 4rem;
            color: var(--primary-blue);
            margin-bottom: 20px;
        }

        .permission-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(45deg, var(--primary-blue), var(--secondary-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .permission-text {
            color: var(--text-gray);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .permission-steps {
            text-align: left;
            margin-bottom: 25px;
            background: var(--input-blue);
            padding: 20px;
            border-radius: 10px;
        }

        .permission-step {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            color: var(--text-white);
        }

        .permission-step i {
            color: var(--primary-blue);
            margin-right: 10px;
            width: 20px;
        }

        .permission-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .permission-content {
                padding: 20px;
            }
            
            .permission-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ HTML –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <!-- ... -->

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π -->
    <div class="permission-modal" id="permission-modal">
        <div class="permission-content">
            <div class="permission-icon">
                <i class="fas fa-microphone"></i>
            </div>
            <h3 class="permission-title">–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</h3>
            <p class="permission-text">
                –î–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∑–≤–æ–Ω–∫–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.
            </p>
            
            <div class="permission-steps">
                <div class="permission-step">
                    <i class="fas fa-camera"></i>
                    <span>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ –∫–∞–º–µ—Ä—ã –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞</span>
                </div>
                <div class="permission-step">
                    <i class="fas fa-check-circle"></i>
                    <span>–í—ã–±–µ—Ä–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å" –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</span>
                </div>
                <div class="permission-step">
                    <i class="fas fa-redo"></i>
                    <span>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è</span>
                </div>
            </div>

            <div class="permission-actions">
                <button class="btn-3d btn-3d-primary" id="retry-permission-btn">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
                <button class="btn-3d btn-3d-secondary" id="close-permission-btn">–ü–æ–∑–∂–µ</button>
            </div>
        </div>
    </div>

    <script>
        // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ localStorage
        class IgnatDB {
            constructor() {
                this.storage = localStorage;
                this.init();
            }

            init() {
                this.restoreSession();
            }

            saveSession(user) {
                this.storage.setItem('ignat_current_user', JSON.stringify(user));
            }

            getCurrentSession() {
                const session = this.storage.getItem('ignat_current_user');
                return session ? JSON.parse(session) : null;
            }

            clearSession() {
                this.storage.removeItem('ignat_current_user');
            }

            restoreSession() {
                const currentUser = this.getCurrentSession();
                if (currentUser) {
                    currentUser.lastSeen = new Date().toISOString();
                    currentUser.isOnline = true;
                    this.saveSession(currentUser);
                    this.updateUser(currentUser.id, {
                        lastSeen: currentUser.lastSeen,
                        isOnline: true
                    });
                }
                return currentUser;
            }

            async addUser(user) {
                const users = this.getUsers();
                users.push(user);
                this.storage.setItem('ignat_users', JSON.stringify(users));
                this.saveSession(user);
                return user.id;
            }

            getUsers() {
                return JSON.parse(this.storage.getItem('ignat_users') || '[]');
            }

            async getUserByUsername(username) {
                const users = this.getUsers();
                return users.find(user => user.username === username);
            }

            async getUserById(userId) {
                const users = this.getUsers();
                return users.find(user => user.id === userId);
            }

            async getAllUsers() {
                return this.getUsers();
            }

            async searchUsers(query) {
                const users = this.getUsers();
                const searchTerm = query.toLowerCase();
                return users.filter(user => 
                    user.username.toLowerCase().includes(searchTerm)
                );
            }

            async updateUser(userId, updates) {
                const users = this.getUsers();
                const userIndex = users.findIndex(user => user.id === userId);
                if (userIndex !== -1) {
                    users[userIndex] = { ...users[userIndex], ...updates };
                    this.storage.setItem('ignat_users', JSON.stringify(users));
                    
                    const currentUser = this.getCurrentSession();
                    if (currentUser && currentUser.id === userId) {
                        this.saveSession(users[userIndex]);
                    }
                    
                    return users[userIndex];
                }
                return null;
            }

            async getSettings(userId) {
                const settings = JSON.parse(this.storage.getItem('ignat_settings') || '{}');
                return settings[userId] || {};
            }

            async saveSettings(userId, newSettings) {
                const settings = JSON.parse(this.storage.getItem('ignat_settings') || '{}');
                settings[userId] = { ...settings[userId], ...newSettings };
                this.storage.setItem('ignat_settings', JSON.stringify(settings));
            }

            async addChat(chat) {
                const chats = this.getChats();
                chats.push(chat);
                this.storage.setItem('ignat_chats', JSON.stringify(chats));
                return chat.id;
            }

            getChats() {
                return JSON.parse(this.storage.getItem('ignat_chats') || '[]');
            }

            async getChat(chatId) {
                const chats = this.getChats();
                return chats.find(chat => chat.id === chatId);
            }

            async getUserChats(userId) {
                const chats = this.getChats();
                return chats.filter(chat => 
                    chat.participants.includes(userId)
                ).sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
            }

            async getAllChats() {
                return this.getChats();
            }

            async findChatBetweenUsers(user1Id, user2Id) {
                const chats = this.getChats();
                return chats.find(chat =>
                    chat.participants.includes(user1Id) &&
                    chat.participants.includes(user2Id) &&
                    chat.participants.length === 2
                );
            }

            async updateChat(chatId, updates) {
                const chats = this.getChats();
                const chatIndex = chats.findIndex(chat => chat.id === chatId);
                if (chatIndex !== -1) {
                    chats[chatIndex] = { ...chats[chatIndex], ...updates };
                    this.storage.setItem('ignat_chats', JSON.stringify(chats));
                    return chats[chatIndex];
                }
                return null;
            }

            async addMessage(message) {
                const messages = this.getMessages();
                messages.push(message);
                this.storage.setItem('ignat_messages', JSON.stringify(messages));
                return message.id;
            }

            getMessages() {
                return JSON.parse(this.storage.getItem('ignat_messages') || '[]');
            }

            async getChatMessages(chatId) {
                const messages = this.getMessages();
                return messages
                    .filter(message => message.chatId === chatId)
                    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            }

            async getLastMessage(chatId) {
                const messages = await this.getChatMessages(chatId);
                return messages[messages.length - 1];
            }

            async updateMessage(messageId, updates) {
                const messages = this.getMessages();
                const messageIndex = messages.findIndex(msg => msg.id === messageId);
                if (messageIndex !== -1) {
                    messages[messageIndex] = { ...messages[messageIndex], ...updates };
                    this.storage.setItem('ignat_messages', JSON.stringify(messages));
                    return messages[messageIndex];
                }
                return null;
            }

            async addFile(file) {
                const files = this.getFiles();
                files.push(file);
                this.storage.setItem('ignat_files', JSON.stringify(files));
                return file.id;
            }

            getFiles() {
                return JSON.parse(this.storage.getItem('ignat_files') || '[]');
            }

            async getFile(fileId) {
                const files = this.getFiles();
                return files.find(file => file.id === fileId);
            }

            // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
            async addVoiceMessage(voiceMessage) {
                const voiceMessages = this.getVoiceMessages();
                voiceMessages.push(voiceMessage);
                this.storage.setItem('ignat_voice_messages', JSON.stringify(voiceMessages));
                return voiceMessage.id;
            }

            getVoiceMessages() {
                return JSON.parse(this.storage.getItem('ignat_voice_messages') || '[]');
            }

            async getChatVoiceMessages(chatId) {
                const voiceMessages = this.getVoiceMessages();
                return voiceMessages.filter(msg => msg.chatId === chatId);
            }

            // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
            async blockUser(userId, targetUserId) {
                const blocked = this.getBlockedUsers();
                if (!blocked[userId]) {
                    blocked[userId] = [];
                }
                
                if (!blocked[userId].includes(targetUserId)) {
                    blocked[userId].push(targetUserId);
                    this.storage.setItem('ignat_blocked_users', JSON.stringify(blocked));
                }
            }

            async unblockUser(userId, targetUserId) {
                const blocked = this.getBlockedUsers();
                if (blocked[userId]) {
                    blocked[userId] = blocked[userId].filter(id => id !== targetUserId);
                    this.storage.setItem('ignat_blocked_users', JSON.stringify(blocked));
                }
            }

            getBlockedUsers() {
                return JSON.parse(this.storage.getItem('ignat_blocked_users') || '{}');
            }

            isUserBlocked(userId, targetUserId) {
                const blocked = this.getBlockedUsers();
                return blocked[userId] && blocked[userId].includes(targetUserId);
            }

            getBlockedUsersList(userId) {
                const blocked = this.getBlockedUsers();
                return blocked[userId] || [];
            }

            clearDatabase() {
                this.storage.removeItem('ignat_users');
                this.storage.removeItem('ignat_chats');
                this.storage.removeItem('ignat_messages');
                this.storage.removeItem('ignat_files');
                this.storage.removeItem('ignat_voice_messages');
                this.storage.removeItem('ignat_settings');
                this.storage.removeItem('ignat_blocked_users');
                this.storage.removeItem('ignat_wallpaper');
                this.clearSession();
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–µ–¥–∏–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        function checkMediaSupport() {
            return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        async function checkPermissions() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É API
                if (!checkMediaSupport()) {
                    throw new Error('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω
                const microphonePermission = await navigator.permissions.query({ name: 'microphone' });
                const cameraPermission = await navigator.permissions.query({ name: 'camera' });
                
                return {
                    microphone: microphonePermission.state,
                    camera: cameraPermission.state,
                    supported: true
                };
            } catch (error) {
                console.warn('Permission API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:', error);
                return {
                    microphone: 'prompt',
                    camera: 'prompt',
                    supported: false
                };
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏
        function showPermissionModal() {
            document.getElementById('permission-modal').style.display = 'flex';
        }

        function hidePermissionModal() {
            document.getElementById('permission-modal').style.display = 'none';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const db = new IgnatDB();
        let currentUser = null;
        let currentChat = null;
        let updateInterval = null;
        let replyingToMessage = null;
        let pinnedMessage = null;
        let filesToSend = [];

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;
        let recordingTimer = null;
        let voiceMessages = {};

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let callTimer = null;
        let callStartTime = null;
        let isInCall = false;
        let isVideoCall = false;
        let isAudioMuted = false;
        let isVideoMuted = false;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const landingPage = document.getElementById('landing-page');
        const authContainer = document.getElementById('auth-container');
        const messengerContainer = document.getElementById('messenger-container');
        const settingsWindow = document.getElementById('settings-window');
        const callContainer = document.getElementById('call-container');
        const incomingCallNotification = document.getElementById('incoming-call-notification');
        const permissionModal = document.getElementById('permission-modal');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–≥–Ω–∞—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤
            if (!checkMediaSupport()) {
                console.warn('–ú–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∑–≤–æ–Ω–∫–æ–≤
                document.getElementById('voice-record-btn').style.display = 'none';
                document.getElementById('audio-call-btn').style.display = 'none';
                document.getElementById('video-call-btn').style.display = 'none';
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–º—É
            const savedTheme = getTheme();
            setTheme(savedTheme);
            document.getElementById('theme-toggle').checked = savedTheme === 'light';
            document.getElementById('theme-setting').checked = savedTheme === 'light';
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–æ–∏
            const savedWallpaper = getWallpaper();
            setWallpaper(savedWallpaper);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é
            currentUser = db.restoreSession();
            if (currentUser) {
                messengerContainer.style.display = 'block';
                landingPage.style.display = 'none';
                authContainer.style.display = 'none';
                
                document.getElementById('user-avatar').textContent = currentUser.avatar;
                document.getElementById('user-name').textContent = currentUser.username;
                
                if (currentUser.customAvatar) {
                    document.getElementById('user-avatar').style.backgroundImage = `url(${currentUser.customAvatar})`;
                    document.getElementById('user-avatar').textContent = '';
                }
                
                loadUserChats();
                startOnlineUpdates();
                showNotification(`–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${currentUser.username}!`, 'success');
            } else {
                landingPage.style.display = 'block';
                authContainer.style.display = 'none';
                messengerContainer.style.display = 'none';
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
            document.getElementById('retry-permission-btn').addEventListener('click', function() {
                hidePermissionModal();
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                showNotification('–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π', 'info');
            });

            document.getElementById('close-permission-btn').addEventListener('click', function() {
                hidePermissionModal();
            });

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π...
            // ... (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞)

            // –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
            document.getElementById('voice-record-btn').addEventListener('mousedown', startVoiceRecording);
            document.getElementById('voice-record-btn').addEventListener('touchstart', startVoiceRecording);
            document.getElementById('voice-record-btn').addEventListener('mouseup', stopVoiceRecording);
            document.getElementById('voice-record-btn').addEventListener('touchend', stopVoiceRecording);
            document.addEventListener('mouseup', cancelVoiceRecording);
            document.addEventListener('touchend', cancelVoiceRecording);

            // –ó–≤–æ–Ω–∫–∏ - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
            document.getElementById('audio-call-btn').addEventListener('click', function() {
                if (!currentChat) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –∑–≤–æ–Ω–∫–∞', 'error');
                    return;
                }
                startCall(false);
            });

            document.getElementById('video-call-btn').addEventListener('click', function() {
                if (!currentChat) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –∑–≤–æ–Ω–∫–∞', 'error');
                    return;
                }
                startCall(true);
            });

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏...
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        async function startVoiceRecording(e) {
            e.preventDefault();
            
            if (!currentChat) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                return;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
                if (!checkMediaSupport()) {
                    showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞', 'error');
                    return;
                }

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                }).catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage = '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                        showPermissionModal();
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.';
                    } else if (error.name === 'NotSupportedError') {
                        errorMessage = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞.';
                    } else if (error.name === 'NotReadableError') {
                        errorMessage = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
                    }
                    
                    throw new Error(errorMessage);
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ç–æ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞—É–¥–∏–æ –¥–æ—Ä–æ–∂–∫–∏
                if (stream.getAudioTracks().length === 0) {
                    throw new Error('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                }

                // –°–æ–∑–¥–∞–µ–º MediaRecorder —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π MIME —Ç–∏–ø–æ–≤
                const options = { 
                    audioBitsPerSecond: 128000,
                    mimeType: 'audio/webm;codecs=opus' 
                };
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É MIME —Ç–∏–ø–∞
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    delete options.mimeType; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∏–ø –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                }

                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('voice-record-btn').classList.add('recording');
                showRecordingIndicator();
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–∏
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ MediaRecorder
                mediaRecorder.onerror = (event) => {
                    console.error('–û—à–∏–±–∫–∞ MediaRecorder:', event.error);
                    stopVoiceRecording();
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞', 'error');
                };
                
                // –¢–∞–π–º–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∏
                recordingTimer = setInterval(updateRecordingTime, 1000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞:', error);
                showNotification(error.message, 'error');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –Ω–∞—á–∞—Ç–∞
                if (isRecording) {
                    stopVoiceRecording();
                }
            }
        }

        function stopVoiceRecording() {
            if (!isRecording || !mediaRecorder) return;
            
            try {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å
                if (mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                isRecording = false;
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('voice-record-btn').classList.remove('recording');
                hideRecordingIndicator();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ø–∏—Å–∏:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        async function startCall(isVideo) {
            if (!currentChat) return;
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É
                if (!checkMediaSupport()) {
                    showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏', 'error');
                    return;
                }

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤
                const constraints = {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: isVideo ? {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    } : false
                };

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
                localStream = await navigator.mediaDevices.getUserMedia(constraints)
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º:', error);
                        
                        let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ ';
                        if (isVideo) {
                            errorMessage += '–∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
                        } else {
                            errorMessage += '–º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
                        }
                        
                        if (error.name === 'NotAllowedError') {
                            errorMessage += '. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                            showPermissionModal();
                        } else if (error.name === 'NotFoundError') {
                            errorMessage += '. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
                        } else if (error.name === 'NotSupportedError') {
                            errorMessage += '. –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é.';
                        } else if (error.name === 'NotReadableError') {
                            errorMessage += '. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
                        }
                        
                        throw new Error(errorMessage);
                    });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—É—á–µ–Ω—ã –Ω—É–∂–Ω—ã–µ –¥–æ—Ä–æ–∂–∫–∏
                if (localStream.getAudioTracks().length === 0) {
                    throw new Error('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                }

                if (isVideo && localStream.getVideoTracks().length === 0) {
                    throw new Error('–ö–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞');
                }

                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–≤–æ–Ω–∫–∞
                isVideoCall = isVideo;
                setupCallInterface(isVideo);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–≤–æ–Ω–∫–∞
                callContainer.style.display = 'flex';
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
                if (isVideo) {
                    document.getElementById('local-video').srcObject = localStream;
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –∑–≤–æ–Ω–∫–∞
                startCallTimer();
                
                showNotification(`–ó–≤–æ–Ω–æ–∫ ${isVideo ? '–≤–∏–¥–µ–æ' : '–∞—É–¥–∏–æ'} –Ω–∞—á–∞—Ç`, 'info');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞:', error);
                showNotification(error.message, 'error');
                
                // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
            }
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        // ... (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞)

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        function showRecordingIndicator() {
            const container = document.getElementById('chat-messages');
            
            const recordingElement = document.createElement('div');
            recordingElement.className = 'voice-recording-indicator';
            recordingElement.id = 'recording-indicator';
            recordingElement.innerHTML = `
                <div class="recording-dot"></div>
                <div class="recording-time" id="recording-time">00:00</div>
                <div class="recording-cancel-hint">–û—Ç–ø—É—Å—Ç–∏—Ç–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, —Å–º–∞—Ö–Ω–∏—Ç–µ –¥–ª—è –æ—Ç–º–µ–Ω—ã</div>
            `;
            
            container.appendChild(recordingElement);
            scrollToBottom();
        }

        function hideRecordingIndicator() {
            const recordingElement = document.getElementById('recording-indicator');
            if (recordingElement) {
                recordingElement.remove();
            }
        }

        function updateRecordingTime() {
            const recordingTimeElement = document.getElementById('recording-time');
            if (recordingTimeElement) {
                const elapsedSeconds = Math.floor((Date.now() - recordingStartTime) / 1000);
                recordingTimeElement.textContent = formatTime(elapsedSeconds);
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function setupCallInterface(isVideo) {
            if (isVideo) {
                document.getElementById('video-call-container').style.display = 'flex';
                document.getElementById('audio-call-container').style.display = 'none';
                document.getElementById('incoming-call-container').style.display = 'none';
            } else {
                document.getElementById('video-call-container').style.display = 'none';
                document.getElementById('audio-call-container').style.display = 'flex';
                document.getElementById('incoming-call-container').style.display = 'none';
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                const chat = db.getChat(currentChat);
                if (chat && !chat.isGroup) {
                    const otherUserId = chat.participants.find(id => id !== currentUser.id);
                    const otherUser = db.getUserById(otherUserId);
                    
                    if (otherUser) {
                        document.getElementById('call-user-avatar').textContent = otherUser.avatar;
                        document.getElementById('call-user-name').textContent = otherUser.username;
                    }
                }
            }
        }

        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const elapsedSeconds = Math.floor((Date.now() - callStartTime) / 1000);
                const timerElements = document.querySelectorAll('.call-timer');
                timerElements.forEach(el => {
                    el.textContent = formatTime(elapsedSeconds);
                });
            }, 1000);
        }

        function cancelVoiceRecording(e) {
            if (isRecording) {
                const voiceBtn = document.getElementById('voice-record-btn');
                const rect = voiceBtn.getBoundingClientRect();
                const isInside = (
                    e.clientX >= rect.left &&
                    e.clientX <= rect.right &&
                    e.clientY >= rect.top &&
                    e.clientY <= rect.bottom
                );
                
                if (!isInside) {
                    stopVoiceRecording();
                    showNotification('–ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞', 'info');
                }
            }
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏...
    </script>
</body>
</html>
